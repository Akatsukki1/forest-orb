<!doctype html>
<html lang="en">
<head>
  <title>Yume Nikki Online Project</title>
  <meta charset="utf-8">
  <meta name="description" content="Play Yume Nikki (and fangames) online with your friends, no downloads required.">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="2kkiVersion" content="" data-game-ids="2kki"> <!-- eg. 0.117g Patch 4 -->
  <link rel="stylesheet" href="play.css">
  <style>
    :root {
      --color-gray: hsl(0, 0%, 55%);
      --controls-size: 10vh;
    }

    @media (orientation: landscape) {
      :root {
        --controls-size: 20vh;
      }
    }

    html {
      touch-action: none;
    }

    .unselectable {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }

    #status {
      font-size: 1.5rem;
      color: var(--color-gray);
      text-align: center;
    }

    #gameContainer {
      width: 100%;
      height: 100%;
    }

    #dpad, #apad {
      position: fixed;
      bottom: 1rem;
      z-index: 3;
    }

    #dpad {
      left: 1rem;
    }

    #apad {
      right: 1rem;
    }

    #dpad svg {
      width: calc(2 * var(--controls-size));
      height: calc(2 * var(--controls-size));
      fill: var(--color-gray);
    }

    #dpad svg rect {
      opacity: 0.4;
    }

    #apad > * {
      width: var(--controls-size);
      height: var(--controls-size);
      background-color: var(--color-gray);
      border-radius: 50%;
    }

    #apad > :last-child {
      position: relative;
      right: var(--controls-size);
    }

    #dpad path:not(.active), #apad > *:not(.active) {
      opacity: 0.4;
    }

    @media (hover: hover) and (pointer: fine) {
      #apad, #dpad {
        display: none;
      }
    }

    #layout:fullscreen #dpad, #layout:fullscreen #apad {
      bottom: 6rem;
    }
  </style>
  <style id="themeStyles">
    html, input[type='text'], select {
      color: rgba(216, 216, 216, 1) !important; /*base*/
      background-color: black;
    }

    body, .container, div, input[type='text'] {
      image-rendering: crisp-edges;
      image-rendering: pixelated;
    }

    body {
      background-size: 210px;
      background-position-y: -16px;
      background-image: url('images/ui/2kki/system0/containerbg.png') !important;
    }
    
    body.fullBg {
      background-size: 100%;
    }

    #layout::-webkit-scrollbar-track, #messages::-webkit-scrollbar-track, .modalContent::-webkit-scrollbar-track {
      border: 8px solid transparent;
      border-image: url('images/ui/2kki/system1/border.png') 8 repeat !important;
      background-color: rgba(45, 17, 23, 1); /*basebg*/
      image-rendering: crisp-edges;
      image-rendering: pixelated;
    }

    #layout::-webkit-scrollbar-thumb, #messages::-webkit-scrollbar-thumb, .modalContent::-webkit-scrollbar-thumb {
      border: 8px solid transparent;
      border-image: url('images/ui/2kki/system1/border.png') 6 round !important;
      image-rendering: crisp-edges;
      image-rendering: pixelated;
    }

    #controls button path {
      stroke: rgba(216, 216, 216, 1) !important; /*base*/
    }

    #controls button.toggled path {
      stroke: rgba(255, 255, 157, 1) !important; /*alt*/
    }

    #messages, #chatInputContainer, #enterNameContainer {
      border: 8px solid transparent;
    }
  
    #messages, #enterNameContainer {
      border-image: url('images/ui/2kki/system1/border.png') 10 repeat !important;
    }
  
    #enterNameInstruction, .nameText, .notice, .instruction, .infoLabel, .infoText, .message, h1, a, label {
      background-image: url('images/ui/2kki/system1/font1.png') !important; /*base*/
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      filter: drop-shadow(1.5px 1.5px black /*shadow*/);
    }

    .altText, .nameText, a:not(.modalClose) {
      background-image: url('images/ui/2kki/system1/font4.png') !important; /*alt*/
    }

    #connStatusIcon {
      background: linear-gradient(#b30000, #800000);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    #connStatusIcon.online {
      background-image: linear-gradient(#00b33c, #00802b);
    }

    #locationLabel {
      padding-left: 22px;
    }

    #locationText {
      text-align: right;
    }
  
    .messageContainer {
      border-bottom: 4px solid transparent;
      border-image: url('images/ui/2kki/system1/border.png') 8 repeat !important;
    }

    .container, .modal {
      background-size: 70px;
      background-position-y: -16px;
      background-image: url('images/ui/2kki/system1/containerbg.png') !important;
      border-image: url('images/ui/2kki/system1/border.png') 10 repeat !important;
      border: 24px solid transparent;
    }

    .container.fullBg {
      background-size: 650px;
    }

    .modal.fullBg {
      background-size: calc(100vh - 80px);
    }

    #layout.downscale .container.fullBg {
      background-size: 530px;
    }

    #layout.downscale2 .container.fullBg {
      background-size: 410px;
    }
    
    h1 {
      background-size: 36px;
    }
  
    input[type='text'], select {
      border: 12px solid transparent;
      border-image: url('images/ui/2kki/system1/border.png') 8 repeat !important;
      color: rgba(216, 216, 216, 1) !important; /*base*/
      background-color: rgba(45, 17, 23, 1) !important; /*basebg*/
      text-shadow: 1.5px 1.5px black; /*shadow*/
    }

     /* Safari only */
     @media not all and (min-resolution:.001dpcm) {
      #layout::-webkit-scrollbar-track, #messages::-webkit-scrollbar-track, .modalContent::-webkit-scrollbar-track, #layout::-webkit-scrollbar-thumb, #messages::-webkit-scrollbar-thumb, .modalContent::-webkit-scrollbar-thumb, #messages, #enterNameContainer, .container, .modal, input[type='text'], select {
        border-color: unset !important;
      }

      .messageContainer {
        border-top: 0;
        border-left: 0;
        border-right: 0;
        border-bottom-color: unset !important;
      }

      /* Don't use text background on Safari since it doesn't repeat properly */
      #enterNameInstruction, .notice, .instruction, .message, .infoLabel, .infoText, .altText, h1, a, label {
        -webkit-text-fill-color: unset;
        background-image: none !important;
      }

      .altText, a:not(.modalClose) {
        color: rgba(255, 255, 157, 1); /*alt*/
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/i18next@21.6.4/dist/umd/i18next.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/loc-i18next@0.1.4/dist/umd/loc-i18next.min.js"></script>
</head>
<body>
  <div id="background"></div>
  <div id="content">
    <div id="layout">
      <div id="mainContainer" class="container">
        <div id="gameContainer">
          <div id="controls">
            <div id="leftControls">
              <button id="uploadButton" class="unselectable" data-i18n="[title]tooltips.io.upload">
                <svg viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg" width="24" height="25"><path d="m12.75 18v-3.25h-2.25l3.75-4.25 3.75 4.25h-2.25v3.25h-3m-12.75-16.5q0-1.5 1.5-1.5h11.25l2.25 2.25v9.1m-2.25 5.15h-11.25q-1.5 0-1.5-1.5v-13.5m4.5-1.5v3.75q0 0.75 0.75 0.75h4.5q0.75 0 0.75-0.75v-3.75m-1.75 1v2.5h0.75v-2.5h-0.75m-5.75 15.5v-6.75q0-0.75 0.75-0.75h7.5q0.75 0 0.75 0.75v3.25m0 1.75v1.75m-7.5-6h6m-6 2.25h6m-6 2.25h6" /></svg>
              </button><button id="downloadButton" class="unselectable" data-i18n="[title]tooltips.io.download">
                <svg viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg" width="24" height="25"><path d="m12.75 10.5v3.75h-2.25l3.75 3.75 3.75-3.75h-2.25v-3.75h-3m-12.75-9q0-1.5 1.5-1.5h11.25l2.25 2.25v8.25m-2.25 6h-11.25q-1.5 0-1.5-1.5v-13.5m4.5-1.5v3.75q0 0.75 0.75 0.75h4.5q0.75 0 0.75-0.75v-3.75m-1.75 1v2.5h0.75v-2.5h-0.75m-5.75 15.5v-6.75q0-0.75 0.75-0.75h7.5q0.75 0 0.75 0.75v4.5m0 1.5v0.75m-7.5-6h6m-6 2.25h6m-6 2.25h6" /></svg>
              </button><button id="uiThemeButton" class="unselectable" data-game-ids="yume,2kki,flow,prayers,deepdreams,someday,amillusion" data-i18n="[title]tooltips.uiTheme" style="display: none;">
                <svg viewBox="0 0 21 18" fill="none" xmlns="http://www.w3.org/2000/svg" width="24" height="25"><path d="m4.5 3c4.5-4.5 13.5-3 13.5-0.375m-4.125 6.375c-1.875 0-3.375 1.5-1.875 1.875m3 2.625c3 1.5-4.5 6-10.5 4.5-7.5-3-4.5-12 0-15m9-0.75a1.5 1.5 90 0 0 0 3.75 1.5 1.5 90 0 0 0-3.75m-6 0.75a1.5 1.5 90 0 0 0 3 1.5 1.5 90 0 0 0-3m-3.75 4.5a1.5 1.5 90 0 0 0 3 1.5 1.5 90 0 0 0-3m1.5 5.25a1.5 1.5 90 0 0 0 3 1.5 1.5 90 0 0 0-3m6-0.75a1.5 1.5 90 0 0-0.75 4.5q2.25 0 3-1.875m7.5-14.625q-6 4.5-7.5 10.5l1.5 0.75q4.5-3.75 6-11.25m-7.5 10.5c-3 0-1.5 3-3 4.5 6 0 4.5-3 4.5-3.75m-3.75 2.25c0.75 1.5 1.5 0 1.5 1.275"></path></svg>
              </button><button id="chatButton" class="unselectable" data-i18n="[title]tooltips.toggleChat">
                <svg viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg" width="24" height="25"><path d="m15 18l-6-4.5h-6q-3 0-3-3v-7.5q0-3 3-3h12q3 0 3 3v7.5q0 3-3 3h-1.5l1.5 4.5m-11.25-12.75a1.5 1.5 90 0 0 0 3 1.5 1.5 90 0 0 0 -3m5.25 0a1.5 1.5 90 0 0 0 3 1.5 1.5 90 0 0 0 -3m5.25 0a1.5 1.5 90 0 0 0 3 1.5 1.5 90 0 0 0 -3" /></svg>
              </button><button id="nametagButton" class="unselectable" data-i18n="[title]tooltips.toggleNametags">
                <svg viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg" width="24" height="25"><path d="m0 4.5h18v9h-18v-9m1.5 7.5v-6l3 6v-6m1 6l1.5-6 1.5 6m-2.5-2h2m1.5 2l1-6 1 6 1-6 1 6m1-6v6m0-6h2m-2 3h2m-2 3h2" /></svg>
              </button><button id="playerSoundsButton" class="unselectable" data-i18n="[title]tooltips.togglePlayerSounds">
                <svg viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg" width="24" height="25"><path d="m2.5 0a1 1 0 0 0 0 4 1 1 0 0 0 0 -4m-2.5 18v-12q2.5-1 5 0v12h-5m10-15q5 5 0 10m-2-8.5q3.5 3.5 0 7m-2-5.5q2 2 0 4m9.5-10a1 1 0 0 0 0 4 1 1 0 0 0 0 -4m-2.5 6q2.5-1 5 0v12h-5v-12" /></svg>
              </button>
            </div>
            <div id="rightControls">
              <div id="mapControls" data-game-ids="2kki"></div>
              <div id="explorerControls" data-game-ids="2kki" style="display: none;"></div>
              <button id="controls-fullscreen" class="unselectable">
                <svg viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg" width="25" height="25"><path d="M13.5 13.5H10m3.5 0V10m0 3.5l-4-4m.5-8h3.5m0 0V5m0-3.5l-4 4M5 1.5H1.5m0 0V5m0-3.5l4 4m-4 4.5v3.5m0 0H5m-3.5 0l4-4"></path></svg>
              </button>
            </div>
          </div>

          <div id="status"></div>

          <div id="canvasContainer">
            <canvas id="canvas" tabindex="-1"></canvas>
          </div>

          <div id="dpad" class="unselectable">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 72 72">
              <path id="dpad-up" data-key="ArrowUp" data-key-code="38" d="M48,5.8C48,2.5,45.4,0,42,0H29.9C26.6,0,24,2.4,24,5.8V24h24V5.8z" />
              <path id="dpad-right" data-key="ArrowRight" data-key-code="39" d="M66.2,24H48v24h18.2c3.3,0,5.8-2.7,5.8-6V29.9C72,26.5,69.5,24,66.2,24z" />
              <path id="dpad-down" data-key="ArrowDown" data-key-code="40" d="M24,66.3c0,3.3,2.6,5.7,5.9,5.7H42c3.3,0,6-2.4,6-5.7V48H24V66.3z" />
              <path id="dpad-left" data-key="ArrowLeft" data-key-code="37" d="M5.7,24C2.4,24,0,26.5,0,29.9V42c0,3.3,2.3,6,5.7,6H24V24H5.7z" />
              <rect id="dpad-center" x="24" y="24" width="24" height="24" />
            </svg>
          </div>

          <div id="apad" class="unselectable">
            <div id="apad-escape" data-key="Escape" data-key-code="27"></div>
            <div id="apad-enter" data-key="Enter" data-key-code="13"></div>
          </div>
      </div>
    </div>
    <div id="chatboxContainer" class="container" style="display: none">
      <div id="chatbox">
        <div id="onlineInfo" class="info hidden">
          <span id="connStatus" class="infoContainer"><span id="connStatusIcon">●</span> <label id="connStatusText" class="infoText">Disconnected</label></span><span id="playerCountLabel" class="infoLabel"></span>
        </div>
        <div id="location" style="display: none" class="info hidden" data-game-ids="2kki">
          <span id="locationLabel" class="infoLabel" data-i18n="[html]chatbox.location">Location:&nbsp;</span><span id="locationText" class="infoText"></span>
        </div>
        <div id="messages"></div>
        <div id="chatInputContainer" style="display: none">
          <form action="javascript:chatInputActionFired()">
            <input id="chatInput" type="text" autocomplete="off" maxlength="200" disabled="true" data-sys="" />
          </form>
        </div>
        <div id="enterNameContainer">
          <span id="enterNameInstruction">
            <span data-i18n="[html]chatbox.nickname.header">You must set a nickname before you can chat.</span>
            <br>
            <small>
              <span data-i18n="[html]chatbox.nickname.rule.maxLength">* Maximum 12 characters</span>
              <br>
              <span data-i18n="[html]chatbox.nickname.rule.alphanumeric">* Alphanumeric characters only</span>
            </small>
          </span>
          <form id="enterNameForm" action="javascript:chatNameCheck()">
            <input id="nameInput" type="text" autocomplete="off" maxlength="12"></input>
          </form>
        </div>
      </div>
    </div>
    <div id="modalContainer" class="hidden">
      <div id="uiThemesModal" class="modal hidden">
        <a href="javascript:void(0);" class="modalClose">✖</a>
        <div class="modalHeader">
          <h1 data-i18n="[html]modal.uiTheme.title">UI Theme</h1>
        </div>
        <div class="modalContent"></div>
        <div class="modalFooter">
          <div class="uiControl">
            <label for="fontStyle" class="unselectable" data-i18n="[html]fontStyle.label">Font Style:</label>
            <select id="fontStyle" class="fontStyle">
              <option value="0" data-i18n="[html]fontStyle.values.style1">Style 1</option>
              <option value="1" data-i18n="[html]fontStyle.values.style2">Style 2</option>
              <option value="2" data-i18n="[html]fontStyle.values.style3" data-game-ids="yume,2kki,flow,prayers,deepdreams,someday,amillusion">Style 3</option>
              <option value="3" data-i18n="[html]fontStyle.values.style4" data-game-ids="yume,2kki,flow,prayers,someday,amillusion">Style 4</option>
              <option value="4" data-i18n="[html]fontStyle.values.style5" data-game-ids="yume,2kki,flow">Style 5</option>
              <option value="5" data-i18n="[html]fontStyle.values.style6" data-game-ids="yume,2kki,flow">Style 6</option>
              <option value="6" data-i18n="[html]fontStyle.values.style7" data-game-ids="yume,2kki,flow">Style 7</option>
            </select>
          </div>
        </div>
      </div>
      <div class="modalOverlay"></div>
    </div>
  </div>
  <div data-game-ids="2kki" style="display: none;">
    <br>
    <div class="notice version">Yume 2kki Version <span id="2kkiVersion"></span></div>
    <div class="notice" data-i18n="[html]2kki.hostedWithPermission">Hosted with permission from the Yume 2kki developers</div>
  </div>
  <br>
  <div class="instruction"><a href="https://discord.gg/fRG3AxUeKN" data-i18n="[html]instruction.discord">Join our Discord!</a></div>
  <br>
  <div id="langContainer">
    <label for="lang" class="unselectable" data-i18n="[html]lang.label">Language:</label>
    <select id="lang">
      <option value="en">English</option>
      <option value="ja">日本語</option>
      <option value="zh">中文</option>
      <option value="ko">한국어</option>
      <option value="es">Español</option>
      <option value="pt">Português</option>
      <option value="fr">Français</option>
      <option value="de">Deutsch</option>
      <option value="ru">Русский</option>
    </select>
  </div>
  <div id="backgroundTransition"></div>
</div>
<script>
  const gameIds = ['yume', '2kki', 'flow', 'prayers', 'deepdreams', 'someday', 'amillusion'];
  const gameIdMatch = new RegExp('(?:' + gameIds.join('|') + ')').exec(window.location);
  const gameId = gameIdMatch ? gameIdMatch[0] : gameIds[1];
  Module = {
    EASYRPG_GAME: gameId,
    EASYRPG_WS_URL: 'wss://ynoproject.net/connect/' + gameId + '/'
  };
</script>
<script type="text/javascript" src="index.js"></script>
<script type="text/javascript" src="chat.js"></script>

<script>
const hasTouchscreen = window.matchMedia('(hover: none), (pointer: coarse)').matches;
const preventNativeKeys = ['ArrowUp', 'ArrowDown', 'ArrowRight', 'ArrowLeft', ' ', 'F12'];
const keys = new Map();
const keysDown = new Map();
const canvas = document.getElementById('canvas');
const gameContainer = document.getElementById('gameContainer');
let lastTouchedId;

// Make EasyRPG player embeddable
gameContainer.addEventListener('mouseenter', () => canvas.focus());
gameContainer.addEventListener('click', () => canvas.focus());

// Handle clicking on the fullscreen button
document.querySelector('#controls-fullscreen').addEventListener('click', () => {
  const layout = document.getElementById('layout');
  if (layout.requestFullscreen) {
    if (!document.fullscreenElement) {
      layout.requestFullscreen();
      setFullscreenControlsHideTimer();
    } else
      document.exitFullscreen();
  }
});

/**
 * Simulate a keyboard event on the emscripten canvas
 *
 * @param {string} eventType Type of the keyboard event
 * @param {string} key Key to simulate
 * @param {number} keyCode Key code to simulate (deprecated)
 */
function simulateKeyboardEvent(eventType, key, keyCode) {
  const event = new Event(eventType, { bubbles: true });
  event.key = key;
  event.code = key;
  // Deprecated, but necessary for emscripten somehow
  event.keyCode = keyCode;
  event.which = keyCode;

  canvas.dispatchEvent(event);
}

/**
 * Simulate a keyboard input from `keydown` to `keyup`
 *
 * @param {string} key Key to simulate
 * @param {number} keyCode Key code to simulate (deprecated)
 */
function simulateKeyboardInput(key, keyCode) {
  simulateKeyboardEvent('keydown', key, keyCode);
  window.setTimeout(() => {
    simulateKeyboardEvent('keyup', key, keyCode);
  }, 100);
}

/**
 * Bind a node by a specific key to simulate on touch
 *
 * @param {*} node The node to bind a key to
 * @param {string} key Key to simulate
 * @param {number} keyCode Key code to simulate (deprecated)
 */
function bindKey(node, key, keyCode) {
  keys.set(node.id, { key, keyCode });

  node.addEventListener('touchstart', event => {
    event.preventDefault();
    simulateKeyboardEvent('keydown', key, keyCode);
    keysDown.set(event.target.id, node.id);
    node.classList.add('active');
  });

  node.addEventListener('touchend', event => {
    event.preventDefault();

    const pressedKey = keysDown.get(event.target.id);
    if (pressedKey && keys.has(pressedKey)) {
      const { key, keyCode } = keys.get(pressedKey);
      simulateKeyboardEvent('keyup', key, keyCode);
    }

    keysDown.delete(event.target.id);
    node.classList.remove('active');
  
    if (lastTouchedId) {
      document.getElementById(lastTouchedId).classList.remove('active');
    }
  });

  // Inspired by https://github.com/pulsejet/mkxp-web/blob/262a2254b684567311c9f0e135ee29f6e8c3613e/extra/js/dpad.js
  node.addEventListener('touchmove', event => {
    const { target, clientX, clientY } = event.changedTouches[0];
    const origTargetId = keysDown.get(target.id);
    const nextTargetId = document.elementFromPoint(clientX, clientY).id;
    if (origTargetId === nextTargetId) return;

    if (origTargetId) {
      const { key, keyCode } = keys.get(origTargetId);
      simulateKeyboardEvent('keyup', key, keyCode);
      keysDown.delete(target.id);
      document.getElementById(origTargetId).classList.remove('active');
    }

    if (keys.has(nextTargetId)) {
      const { key, keyCode } = keys.get(nextTargetId);
      simulateKeyboardEvent('keydown', key, keyCode);
      keysDown.set(target.id, nextTargetId);
      lastTouchedId = nextTargetId;
      document.getElementById(nextTargetId).classList.add('active');
    }
  })
}

// Bind all elements providing a `data-key` attribute with the
// given key on touch-based devices
if (hasTouchscreen) {
  for (const button of document.querySelectorAll('[data-key]')) {
    bindKey(button, button.dataset.key, button.dataset.keyCode);
  }
} else {
  // Prevent scrolling when pressing specific keys
  canvas.addEventListener('keydown', event => {
    if (preventNativeKeys.includes(event.key)) {
      event.preventDefault();
    }
  });

  canvas.addEventListener('contextmenu', event => {
    event.preventDefault();
    // simulateKeyboardInput('Escape', 27);
  });

  // canvas.addEventListener('click', () => {
  //   simulateKeyboardInput('Enter', 13);
  // });
}
</script>
<script data-game-ids="2kki">
  const is2kki = gameId === '2kki';
  let cachedMapId = null;
  let cachedLocations = null;
  const unknownLocations = [];
  const ignoredMapIds = ['0899', '0900', '1581'];
  let defaultLocations;

  // called from EasyRPG player
  function onLoadMap(mapName) {
    if (gameId !== '2kki')
      return;
    let mapIdMatch = /^Map(\d{4})\.lmu$/.exec(mapName);
    if (mapIdMatch) {
      const mapId = mapIdMatch[1];

      if (mapId === cachedMapId || ignoredMapIds.indexOf(mapId) > -1)
        return;

      const locationKey = `${(cachedMapId || '0000')}_${mapId}`;

      let locations = locationCache[locationKey] || null;

      if (locations && typeof locations === 'string')
        locations = null;

      const useDefaultLocation = defaultLocations.hasOwnProperty(mapId);

      if (useDefaultLocation)
        locations = defaultLocations[mapId];
      else if (unknownLocations.indexOf(locationKey) > -1)
        locations = getMassagedLabel(localizedMessages['2kki'].location.unknownLocation);

      if (!cachedMapId)
        document.getElementById('location').classList.remove('hidden');
      
      if (locations && locations.length) {
        const cacheLocation = useDefaultLocation && !locationCache.hasOwnProperty(locationKey);
        const locationNames = Array.isArray(locations) ? locations.map(l => l.title) : null;
        setLocation(mapId, cachedMapId, locations, cachedLocations, cacheLocation);
        cachedMapId = mapId;
        cachedLocations = locationNames ? locations : null;
        if (!locationNames) {
          setExplorerLinks(null);
          setMaps([]);
        } else {
          setExplorerLinks(!useDefaultLocation ? locationNames : null);
          if (useDefaultLocation) {
            const cacheMap = useDefaultLocation && !mapCache.hasOwnProperty(locationNames.join(','));
            setMaps([], locationNames, cacheMap, cacheMap);
          } else if (mapCache.hasOwnProperty(locationNames.join(',')))
            setMaps(mapCache[locationNames.join(',')], locationNames);
          else
            queryAndSetMaps(locationNames).catch(err => console.error(err));
        }
      } else {
        queryAndSetLocation(mapId, cachedMapId, cachedLocations)
          .then(locationNames => {
            setExplorerLinks(locationNames);
            if (locationNames)
              queryAndSetMaps(locationNames).catch(err => console.error(err));
            else {
              setMaps([], null, true, true);
              setExplorerLinks(null);
            }
          }).catch(err => console.error(err));
      }
    }
  }
  
  function queryAndSetLocation(mapId, prevMapId, prevLocations) {
    return new Promise((resolve, reject) => {
      const req = new XMLHttpRequest();
        let url = `https://2kki.app/getMapLocationNames?mapId=${mapId}`;
        if (prevMapId) {
            url += `&prevMapId=${prevMapId}`;
            if (prevLocations && prevLocations.length && !prevLocations[0].default)
              url += `&prevLocationNames=${prevLocations.map(l => l.title).join('&prevLocationNames=')}`;
        }
        req.responseType = 'json';
        req.open("GET", url);
        req.send();

        setLocation(mapId, prevMapId, getMassagedLabel(localizedMessages['2kki'].location.queryingLocation), prevLocations, true);

        req.onload = (e) => {
          const locationsArray = req.response;
          const locations = [];

          const cacheAndResolve = function () {
            const locationNames = locations.map(l => l.title);

            cachedMapId = mapId;
            cachedLocations = locations;
            resolve(locationNames);
          };

          if (Array.isArray(locationsArray) && locationsArray.length) {
            let location = locationsArray[0];
            let usePrevLocations = false;

            if (locationsArray.length > 1 && prevLocations && prevLocations.length) {
              for (let l of locationsArray) {
                if (l.title === prevLocations[0].title) {
                  location = l;
                  usePrevLocations = true;
                  break;
                }
              }
            }

            locations.push(location);

            if (usePrevLocations) {
              queryConnectedLocationNames(location.title, locationsArray.filter(l => l.title !== location.title).map(l => l.title))
                .then(connectedLocationNames => {
                  const connectedLocations = locationsArray.filter(l => connectedLocationNames.indexOf(l.title) > -1);
                  for (let cl of connectedLocations)
                    locations.push(cl);

                  setLocation(mapId, prevMapId, locations, prevLocations, true, true);

                  cacheAndResolve();
                }).catch(err => reject(err));
                
              return;
            } else
              setLocation(mapId, prevMapId, locations, prevLocations, true, true);
          } else {
            const errCode = !Array.isArray(req.response) ? req.response.err_code : null;
            
            if (errCode)
              console.error({ error: req.response.error, errCode: errCode });

            if (prevMapId) {
              queryAndSetLocation(mapId, null, null).then(() => resolve(null)).catch(err => reject(err));
              return;
            }
            setLocation(mapId, prevMapId, null, prevLocations, true, true);
          }
          cacheAndResolve();
        };
    });
  }

  function setLocation(mapId, prevMapId, locations, prevLocations, cacheLocation, saveLocation) {
    document.getElementById('locationText').innerHTML = locations && locations.length
      ? Array.isArray(locations)
        ? locations.map(l => getLocationLink(l)).join('<br>')
        : locations
      : getMassagedLabel(localizedMessages['2kki'].location.unknownLocation);
    if (cacheLocation) {
      const locationKey = `${(prevMapId || '0000')}_${mapId}`;
      const prevLocationKey = `${mapId}_${(prevMapId || '0000')}`;
      if (locations)
        locationCache[locationKey] = locations;
      else
        unknownLocations.push(locationKey)
      if (prevLocations)
        locationCache[prevLocationKey] = prevLocations;
      if (saveLocation && (locations || prevLocations)) {
        if (locations)
          config.locationCache[locationKey] = locations;
        if (prevLocations)
          config.locationCache[prevLocationKey] = prevLocations;
        updateConfig(config);
      }
    }
  }

  function getLocationLink(location, urlTitle, urlTitleJP) {
    if (!urlTitle)
      urlTitle = location.title;
    if (!urlTitleJP)
      urlTitleJP = (location.titleJP.indexOf("：") > -1 ? location.titleJP.slice(0, location.titleJP.indexOf("：")) : location.titleJP);
    const locationLink = `<a href="https://yume2kki.fandom.com/wiki/${urlTitle}" target="_blank">${location.title}</a>`
    const locationLinkJP = `<a href="https://wikiwiki.jp/yume2kki-t/${urlTitleJP}" target="_blank">${location.titleJP}</a>`;
    return getMassagedLabel(localizedMessages['2kki'].location.template).replace('{LOCATION}', locationLink).replace('{LOCATION_JP}', locationLinkJP);
  }

  function getDefaultLocations() {
    const ret = {
      '0150': [{ title: 'Puzzle Game (Kura Puzzle)', titleJP: 'パズルゲーム', urlTitle: 'Console#PUZZLE_GAME_.28Kura_Puzzle.29', urlTitleJP: 'ミニゲーム/パズルゲーム', default: true }],
      '0620': [{ title: 'Sound Room', titleJP: 'SR分室の曲', urlTitle: 'Soundtrack', urlTitleJP: '収集要素/SR分室の曲・演出の解放条件', default: true }]
    };

    const wavyUpLocation = [{ title: '↑v↑ (Wavy Up)', titleJP: '↑v↑', urlTitle: 'Console#.E2.86.91V.E2.86.91_.28Wavy_Up.29', urlTitleJP: 'ミニゲーム/↑v↑', default: true }];
    for (let i = 121; i <= 130; i++)
      ret[`0${i}`] = wavyUpLocation;

    const platedSnowCountry = [{ title: 'Plated Snow Country', titleJP: 'ゆきぐにっき', urlTitle: 'Console#Plated_Snow_Country', urlTitleJP: 'ミニゲーム/ゆきぐにっき', default: true }];
    for (let i = 249; i <= 250; i++)
      ret[`0${i}`] = platedSnowCountry;

    return ret;
  }

  function queryConnectedLocationNames(locationName, connLocationNames) {
    return new Promise((resolve, reject) => {
      const req = new XMLHttpRequest();
        const url = `https://2kki.app/getConnectedLocations?locationName=${locationName}&connLocationNames=${connLocationNames.join('&connLocationNames=')}`;
        req.responseType = 'json';
        req.open("GET", url);
        req.send();

        req.onload = (e) => {
          let ret = [];
          let errCode = null;

          if (Array.isArray(req.response))
            ret = req.response;
          else
            errCode = req.response.err_code;
            
          if (errCode)
            console.error({ error: req.response.error, errCode: errCode });

          resolve(ret);
        };
    });
  }

  function queryAndSetMaps(locationNames) {
    return new Promise((resolve, reject) => {
      const req = new XMLHttpRequest();
        const url = `https://2kki.app/getLocationMaps?locationNames=${locationNames.join('&locationNames=')}`;
        req.responseType = 'json';
        req.open("GET", url);
        req.send();

        setMaps([], null, true);

        req.onload = (e) => {
          let errCode = null;

          if (Array.isArray(req.response))
            setMaps(req.response, locationNames, true, true);
          else
            errCode = req.response.err_code;
            
          if (errCode)
            console.error({ error: req.response.error, errCode: errCode });

          resolve();
        };
    });
  }

  function setMaps(maps, locationNames, cacheMaps, saveMaps) {
    const mapControls = document.getElementById('mapControls');
    mapControls.innerHTML = '';
    if (maps && maps.length) {
      for (let map of maps)
        mapControls.appendChild(getMapButton(map.url, map.label));
    }
    if (cacheMaps && locationNames) {
      mapCache[locationNames.join(',')] = maps;
      if (saveMaps) {
        config.mapCache[locationNames.join(',')] = maps;
        updateConfig(config);
      }
    }
  }

  function getMapButton(url, label) {
    const ret = document.createElement('button');
    ret.classList.add('mapButton');
    ret.classList.add('unselectable');
    ret.title = label;
    ret.onclick = () => {
      const handle = window.open(url, '_blank', 'noreferrer');
      if (handle)
          handle.focus();
    };
    ret.innerHTML = '<svg viewbox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg" width="25" height="24"><path d="m0 0l4 2 4-2 4 2v10l-4-2-4 2-4-2v-10m4 2v10m4-12v10"></path></svg>';
    return ret;
  }

  function setExplorerLinks(locationNames) {
    const explorerControls = document.getElementById('explorerControls');
    if (!explorerControls)
      return;
    explorerControls.innerHTML = '';
    if (!locationNames)
      return;
    for (let locationName of locationNames)
      explorerControls.appendChild(getExplorerButton(locationName, locationNames.length > 1))
  }

  function getExplorerButton(locationName, isMulti) {
    const ret = document.createElement('button');
    const localizedExplorerLinks = localizedMessages['2kki'].explorerLink;
    ret.title = !isMulti ? localizedExplorerLinks.generic : localizedExplorerLinks.multi.replace('{LOCATION}', locationName);
    ret.classList.add('unselectable');

    const url = `https://2kki.app/?location=${locationName}&lang=${config.lang}`;

    ret.onclick = () => {
      const handle = window.open(url, '_blank');
      if (handle)
          handle.focus();
    };

    ret.innerHTML = '<svg viewbox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg" width="24" height="25"><path d="m6.75 0v4.5h4.5v-4.5h-4.5m2.25 4.5v4.5h-1.5v3h3v-3h-1.5m0-3h-7.5v3h-1.5v3h3v-3h-1.5m7.5-3h7.5v3h-1.5v3h3v-3h-1.5m-7.5 3v3.75h-1.125v2.25h2.25v-2.25h-1.125m0-2.25h-7.5v2.25h-1.125v2.25h2.25v-2.25h-1.125m7.5-2.25h7.5v2.25h-1.125v2.25h2.25v-2.25h-1.125"></path></svg>';

    return ret;
  }

  if (is2kki) {
    // Yume 2kki Explorer doesn't support mobile
    if (hasTouchscreen)
      document.getElementById('explorerControls').remove();
    defaultLocations = getDefaultLocations();
  }
</script>
<script>
  const gameIdsElements = document.querySelectorAll('[data-game-ids]');
  for (let el of gameIdsElements) {
    if (el.dataset.gameIds.split(',').indexOf(gameId) > -1)
      el.style.display = '';
    else
      el.remove();
  }

  const gameUiThemes = {
    'yume': [
      'マイシステムa',
      'マイシステムb',
      'マイシステムc'
    ],
    '2kki': [
      'system1',
      'system2',
      'system3',
      'system4',
      'system5',
      'system0',
      'systemyaguruma',
      'systemrenge',
      'system-b',
      'system-g',
      'system-i',
      'system-iiii2',
      'system-k',
      'system-n',
      'system-o',
      'system-r',
      'system-hw',
      'system_Ca0',
      'Yeris_System_Rainbow',
      'system_Suzume_choco',
      'menu 20',
      'menu 21',
      '2i9_sys1',
      '2i9_sys2',
      '2i9_sys3',
      'Noil-menu25',
      'Noil-menu26',
      'Noil-menu27',
      'RioSystem1-28',
      'RioSystem2-29',
      'Nuaahs_menu',
      'RioSystem3',
      'RioSystem4',
      'system_nantai_33',
      'system_Nulsdodage_Digital',
      'system-lav',
      'Kon_sys_1',
      'Kon_sys_2',
      '2i9_sys4',
      'system_K4_April2021',
      'Nulsdodage_Mono',
      'Kon_sys_3',
      'Kon_sys_4',
      'Kon_sys_5',
      'system_E_eye',
      'Kong_SystemFC',
      'natl_sys_PinkRibbon'
    ],
    'flow': [
      'system',
      'FCシムテム',
      'systemdot',
      'systemorange',
      'system flower',
      'systemsugar',
      'system rust',
      'systemsmile'
    ],
    'prayers': [
      'Default',
      'Alternate_1',
      'Alternate_2'
    ],
    'deepdreams': [
      'Default',
      'Arabian',
      'Crystalline',
      'Kaleidoscope',
      'Rainbow',
      'Spider_Lily'
    ],
    'someday': [
      'Default',
      '8_Bit',
      'Blue',
      'Clock',
      'Edible',
      'Rainbow',
      '311',
      'Turquoise'
    ],
    'amillusion': [
      'Default',
      'Azur',
      'Bubbles',
      'Crazy_Maze',
      'Engraving',
      'EPACSE',
      'Golden_Luck',
      'Sunflower'
    ]
  }[gameId];

  const gameFullBgUiThemes = {
    'yume': [ 'マイシステムb' ],
    '2kki': [],
    'flow': [],
    'prayers': [ 'Default', 'Alternate_1', 'Alternate_2' ],
    'deepdreams': [],
    'someday': [],
    'amillusion': [ 'Azur' ]
  }[gameId];

  const hasUiThemes = gameUiThemes.length > 0;
  const hasAutoUiTheme = hasUiThemes && gameUiThemes[0] !== 'Default';

  let localizedMessages;

  const langLabelMassageFunctions = {
    'ja': (value, isUI) => {
      if (isUI && value.indexOf(' ') > -1)
        return value.split(/ +/g).map(v => `<span class="jp-word-break">${v}</span>`).join('');
      return value;
    },
    'ru': (value, isUI) => {
      return value.replace(/([\u0400-\u04FF]+)/g, '<span class="ru-spacing-fix">$1</span>');
    }
  };

  let config = {
    lang: document.referrer && /\.jp/.test(document.referrer) ? 'ja' : 'en',
    name: ''
  };

  let connStatus;

  function onUpdateConnectionStatus(status) {
    const updateStatusText = function () {
      const connStatusIcon = document.getElementById('connStatusIcon');
      const connStatusText = document.getElementById('connStatusText');
      connStatusIcon.classList.toggle('online', status);
      connStatusText.innerHTML = getMassagedLabel(localizedMessages.connStatus[status]);
      connStatusText.classList.toggle('altText', !status);
    }; 
    if (connStatus !== undefined && !status)
      window.setTimeout(function () {
        if (!connStatus)
          updateStatusText();
      }, 2000);
    else
      updateStatusText();
    connStatus = status;
  }

  let playerCount;

  function updatePlayerCount(count) {
    const playerCountLabel = document.getElementById('playerCountLabel');
    playerCountLabel.innerHTML = getMassagedLabel(localizedMessages.playersOnline.replace('{COUNT}', count));
    if (playerCount === undefined)
      document.getElementById('onlineInfo').classList.remove('hidden');
    playerCount = count;
  }

  let systemName;

  function onUpdateSystemGraphic(name) {
    if (name)
      name = name.replace(/'/g, '');
    if (gameUiThemes.indexOf(name) > -1) {
      systemName = name;
      document.getElementById('chatInput').dataset.sys = systemName;
      if (hasAutoUiTheme) {
        const lastAutoButton = document.querySelector('.uiThemeItem.auto');
        if (lastAutoButton)
          lastAutoButton.remove();
        const uiThemeModalContent = document.querySelector('#uiThemesModal .modalContent');
        const autoUiThemeOption = getUiThemeOption('auto');
        autoUiThemeOption.onclick = onSelectUiTheme;
        uiThemeModalContent.prepend(autoUiThemeOption);
        locI18next.init(i18next)('.uiThemeItem.auto label');
        if (config.uiTheme === 'auto')
          setUiTheme('auto');
      }
    }
  }

  if (hasUiThemes)
    populateUiThemes();

  let locationCache;

  document.getElementById('lang').onchange = function () {
    setLang(this.value);
  };

  {
    const closeModal = function () {
      document.getElementById('modalContainer').classList.add('hidden');
      const activeModal = document.querySelector('.modal:not(.hidden)');
      if (activeModal)
        activeModal.classList.add('hidden');
    };
    const modalCloseButtons = document.querySelectorAll('.modalClose');
    for (let button of modalCloseButtons)
      button.onclick = closeModal;
    document.querySelector('.modalOverlay').onclick = closeModal;
  }

  document.getElementById('enterNameForm').onsubmit = function () {
    setName(this.value);
  };

  document.getElementById('chatButton').onclick = function () {
    this.classList.toggle('toggled');
    document.getElementById('layout').classList.toggle('hideChat');
    onResize();
  };

  document.getElementById('nametagButton').onclick = function () {
    this.classList.toggle('toggled');
    simulateKeyboardInput('2', 50);
  };

  document.getElementById('playerSoundsButton').onclick = function () {
    this.classList.toggle('toggled');
    simulateKeyboardInput('3', 51);
  };

  if (hasUiThemes) {
    config.uiTheme = 'Default';

    document.getElementById('uiThemeButton').onclick = function () {
      document.getElementById('modalContainer').classList.remove('hidden');
      document.getElementById('uiThemesModal').classList.remove('hidden');
    };

    const uiThemes = document.querySelectorAll('.uiTheme');

    for (uiTheme of uiThemes)
      uiTheme.onclick = onSelectUiTheme;
  }

  config.fontStyle = 0;

  document.querySelector('.fontStyle').onchange = function () {
    setFontStyle(parseInt(this.value));
  };

  document.getElementById('uploadButton').onclick = function () {
    let saveFile = document.getElementById('saveFile');
    if (saveFile)
      saveFile.remove();

    saveFile = document.createElement('input');
    saveFile.type = 'file';
    saveFile.id = 'saveFile';
    saveFile.style.display = 'none';
    saveFile.addEventListener('change', handleSaveFileUpload);
    saveFile.click();
  };

  document.getElementById('downloadButton').onclick = handleSaveFileDownload;

  if (gameId === '2kki') {
    document.getElementById('2kkiVersion').innerText = document.querySelector('meta[name="2kkiVersion"]').content || '?';
    locationCache = {};
    mapCache = {};
    config.locationCache = {};
    config.mapCache = {};
  }

  let ignoreSizeChanged = false;

  function onResize() {
    const layout = document.getElementById('layout');
    const canvas = document.getElementById('canvas');

    const downscale = window.innerWidth < 704 || window.innerHeight < 577;
    const downscale2 = window.innerWidth < 544 || window.innerHeight < 457;

    document.getElementById('mainContainer').classList.toggle('noSideBorders', window.innerWidth < 384);

    if (window.innerWidth < window.innerHeight) {
      layout.classList.toggle('downscale', downscale);
      layout.classList.toggle('downscale2', downscale2);
      layout.classList.toggle('overflow', isOverflow(downscale2 ? 0.5 : downscale ? 0.75 : 1));
    } else {
      const overflow = isOverflow();
      if (overflow !== isOverflow(0.75)) {
        layout.classList.toggle('downscale', downscale || overflow);
        layout.classList.remove('downscale2');
        layout.classList.toggle('overflow', !overflow);
      } else if (overflow !== isOverflow(0.5)) {
        layout.classList.toggle('downscale', downscale || overflow);
        layout.classList.toggle('downscale2', downscale2 || overflow);
        layout.classList.toggle('overflow', !overflow);
      } else {
        layout.classList.toggle('downscale', downscale);
        layout.classList.toggle('downscale2', downscale2);
        layout.classList.toggle('overflow', overflow);
      }
    }

    updateCanvasFullscreenSize();
  }

  function isOverflow(scale) {
    return window.innerWidth < 984 && window.innerHeight <= 594 && (window.innerWidth <= 704 || document.getElementById('gameContainer').offsetWidth < (640 * (scale || 1)) + (document.getElementById('layout').classList.contains('overflow') ? 288 : 0));
  }

  function updateCanvasFullscreenSize() {
    const layoutElement = document.getElementById('layout');
    const canvasElement = document.getElementById('canvas');
    const canvasContainerElement = document.getElementById('canvasContainer');
    const chatboxContainerElement = document.getElementById('chatboxContainer');

    let canvasContainerHeight = null;
    let canvasContainerPaddingRight = null;
    let canvasContainerMarginTop = null;
    let chatboxContainerMarginTop = null;
    let chatboxHeight = null;
    let chatboxOverlap = false;
    
    if (document.fullscreenElement) {
      const showChat = !layoutElement.classList.contains('hideChat');
      let scaleX = window.innerWidth / canvasElement.offsetWidth;
      let scaleY = window.innerHeight / canvasElement.offsetHeight;
      const scaleFraction = layoutElement.classList.contains('downscale') ? 0.25 : 0.5;
      scaleX -= scaleX % scaleFraction;
      scaleY -= scaleY % scaleFraction;
      const scale = Math.max(Math.min(scaleX, scaleY), 0.5);
      canvasElement.style.transform = `scale(${scale})`;

      if (window.innerWidth > 1050 || window.innerHeight < 595) {
        const chatboxContainerWidth = chatboxContainerElement.offsetWidth - 24;
        chatboxContainerMarginTop = '24px';
        if (chatboxContainerWidth + 48 <= window.innerWidth - (canvasElement.offsetWidth * scale)) {
          if (showChat)
            canvasContainerPaddingRight = `${chatboxContainerWidth}px`;
        } else
          chatboxOverlap = true;
      } else {
        const canvasScaledHeight = canvasElement.offsetHeight * scale;
        const unusedHeight = window.innerHeight - (canvasScaledHeight + 32);
        if (unusedHeight >= 376 && showChat) {
          canvasContainerMarginTop = `-${(window.innerHeight - canvasScaledHeight) / 2}px`
          chatboxContainerMarginTop = `${(window.innerHeight - unusedHeight) - 40}px`;
          chatboxHeight = `${unusedHeight}px`;
        } else {
          chatboxContainerMarginTop = '24px';
          if (showChat)
            chatboxOverlap = true;
        }
      }
    } else {
      canvasElement.style.transform = null;
      canvasContainer.style.paddingRight = null;
    }

    canvasContainerElement.style.height = canvasContainerHeight;
    canvasContainerElement.style.paddingRight = canvasContainerPaddingRight;
    canvasContainerElement.style.marginTop = canvasContainerMarginTop;
    chatboxContainerElement.style.marginTop = chatboxContainerMarginTop;
    layoutElement.classList.toggle('chatboxOverlap', chatboxOverlap);
    document.getElementById('chatbox').style.height = chatboxHeight;

    document.getElementById("messages").scrollTop = messages.scrollHeight;
  }

  if (Module.postRun)
    Module.postRun.push(onResize);
  window.onresize = function () { window.setTimeout(onResize, 0); };

  document.addEventListener('fullscreenchange', updateCanvasFullscreenSize);

  function toggleControls(show) {
    document.getElementById('controls').classList.toggle('fshidden', !show);
  }

  let fullscreenControlsTimer;

  function setFullscreenControlsHideTimer() {
    if (fullscreenControlsTimer)
      clearInterval(fullscreenControlsTimer);
    fullscreenControlsTimer = setTimeout(function () {
      if (!document.querySelector("#controls button:hover"))
        toggleControls(false);
      fullscreenControlsTimer = null;
    }, 5000);
  }

  document.onmousemove = function () {
    if (document.fullscreenElement) {
      toggleControls(true);
      setFullscreenControlsHideTimer();
    }
  };
  
  window.onbeforeunload = function () {
    return localizedMessages.leavePage;
  };

  function setLang(lang, isInit) {
    config.lang = document.getElementById('lang').value;
    initLocalization(isInit);
    if (!isInit)
      updateConfig(config);
  }
  
  function setName(name, isInit) {
    config.name = document.getElementById('nameInput').value;
    if (!isInit)
      updateConfig(config);
  }

  function getDefaultUiTheme() {
    return !hasAutoUiTheme ? 'Default' : gameUiThemes[0];
  }
  
  function setUiTheme(value, isInit) {
    const isAuto = value === 'auto';
    const uiTheme = isAuto ? systemName || getDefaultUiTheme() : value;
    if (gameUiThemes.indexOf(uiTheme) === -1)
      return;
    if (hasUiThemes)
      config.uiTheme = value;
    const themeStyles = document.getElementById('themeStyles');
    getBaseBgColor(uiTheme, function (color) {
      const bgColorPixel = uiThemeBgColors[uiTheme];
      const altColor = 'rgba(' + Math.min(bgColorPixel[0] + 48, 255) + ', ' + Math.min(bgColorPixel[1] + 48, 255) + ', ' + Math.min(bgColorPixel[2] + 48, 255) + ', 1)';
      getFontShadow(uiTheme, function (shadow) {
        themeStyles.textContent = themeStyles.textContent.replace(new RegExp('url\\(\'images\\/ui\\/[a-zA-Z0-9]+\\/(?:[^\\/]+\\/)?(containerbg|border(?:2)?|font\\d)\\.png\'\\)', 'g'), 'url(\'images/ui/' + gameId + (hasUiThemes ? '/' + uiTheme : '') + '/$1.png\')')
          .replace(/background-color:( *)[^;!]*(!important)?;( *)\/\*basebg\*\//g, 'background-color:$1' + color + '$2;$3/*basebg*/')
          .replace(/background-color:( *)[^;!]*(!important)?;( *)\/\*altbg\*\//g, 'background-color:$1' + altColor + '$2;$3/*altbg*/')
          .replace(/(?:[#a-zA-Z0-9]+|rgba\([0-9]+, [0-9]+, [0-9]+, [0-9]+\))(;? *)\/\*shadow\*\//g, shadow + '$1/*shadow*/');
        const lastSelectedThemeContainer = document.querySelector('.uiThemeContainer.selected');
        const newSelectedTheme = document.querySelector(`.uiTheme[data-ui-theme="${value}"]`);
        if (lastSelectedThemeContainer)
          lastSelectedThemeContainer.classList.remove('selected');
        if (newSelectedTheme)
          newSelectedTheme.parentElement.classList.add('selected');
        const useFullBg = hasUiThemes && gameFullBgUiThemes.indexOf(uiTheme) > -1;
        const containers = document.querySelectorAll('.container');
        const modals = document.querySelectorAll('.modal');
        for (let container of containers)
          container.classList.toggle('fullBg', useFullBg);
        for (let modal of modals)
          modal.classList.toggle('fullBg', useFullBg);
        document.querySelector('body').classList.toggle('fullBg', useFullBg);
        if (!isInit) {
          document.querySelector('.fontStyle').onchange();
          if (hasUiThemes)
            updateConfig(config);
        }
      });
    });
  }
  
  function setFontStyle(fontStyle, isInit) {
    const isAuto = config.uiTheme == 'auto';
    const uiTheme = (isAuto ? systemName : config.uiTheme) || getDefaultUiTheme();
    if (gameUiThemes.indexOf(uiTheme) === -1)
      return;
    config.fontStyle = fontStyle;
    const themeStyles = document.getElementById('themeStyles');
    const defaultAltFontStyleIndex = parseInt(document.querySelector('.fontStyle option:last-child').value);
    getFontColor(uiTheme, fontStyle, function (baseColor) {
      const altFontStyle = fontStyle !== defaultAltFontStyleIndex ? defaultAltFontStyleIndex : 0;
      const altColorCallback = function (altColor) {
        themeStyles.textContent = themeStyles.textContent
          .replace(new RegExp('url\\(\'images\\/ui\\/[a-zA-Z0-9]+\\/(?:[^\\/]+\\/)?font\\d\\.png\'\\)( *!important)?;( *)\\/\\*base\\*\\/', 'g'), 'url(\'images/ui/' + gameId + (hasUiThemes ? '/' + uiTheme : '') + '/font' + (fontStyle + 1) + '.png\')$1;$2/*base*/')
          .replace(new RegExp('url\\(\'images\\/ui\\/[a-zA-Z0-9]+\\/(?:[^\\/]+\\/)?font\\d\\.png\'\\)( *!important)?;( *)\\/\\*alt\\*\\/', 'g'), 'url(\'images/ui/' + gameId + (hasUiThemes ? '/' + uiTheme : '') + '/font' + (altFontStyle + 1) + '.png\')$1;$2/*alt*/')
          .replace(/([^\-])((?:(?:background|border)\-)?color|stroke):( *)[^;!]*(!important)?;( *)\/\*base\*\//g, '$1$2:$3' + baseColor + '$4;$5/*base*/')
          .replace(/([^\-])((?:(?:background|border)\-)?color|stroke):( *)[^;!]*(!important)?;( *)\/\*alt\*\//g, '$1$2:$3' + altColor + '$4;$5/*alt*/');
        if (!isInit)
          updateConfig(config);
      };
      getFontColor(uiTheme, altFontStyle, function (altColor) {
        if (altColor !== baseColor)
          altColorCallback(altColor);
        else {
          const fallbackAltFontStyle = fontStyle !== defaultAltFontStyleIndex ? parseInt(document.querySelector('.fontStyle option:first-child').value) : 1;
          getFontColor(uiTheme, fallbackAltFontStyle, altColorCallback);
        }
      });
    });
  }

  function populateUiThemes() {
    const modalContent = document.querySelector('#uiThemesModal .modalContent');
    modalContent.innerHTML = '';
    if (hasUiThemes && hasAutoUiTheme)
      modalContent.appendChild(getUiThemeOption('auto'));
    for (let uiTheme of gameUiThemes)
      modalContent.appendChild(getUiThemeOption(uiTheme));
  }

  function onSelectUiTheme(e) {
    setUiTheme(e.target.dataset.uiTheme);
  }

  function getUiThemeOption(uiTheme) {
    const isAuto = uiTheme === 'auto';
    if (isAuto)
      uiTheme = systemName || getDefaultUiTheme();

    const item = document.createElement('div');
    item.classList.add('uiThemeItem');
    if (isAuto)
      item.classList.add('auto');
    
    const container = document.createElement('div');
    container.classList.add('uiThemeContainer');

    const option = document.createElement('div');
    option.classList.add('uiTheme');
    if (gameFullBgUiThemes.indexOf(uiTheme) > -1)
      option.classList.add('fullBg');
    option.dataset.uiTheme = isAuto ? 'auto' : uiTheme;
    option.style.backgroundImage = `url('images/ui/${gameId}/${uiTheme}/containerbg.png')`;
    option.style.borderImage = `url('images/ui/${gameId}/${uiTheme}/border.png') 10 repeat`;

    const arrowUp = document.createElement('img');
    arrowUp.src = `images/ui/${gameId}/${uiTheme}/arrowup.png`;
    option.appendChild(arrowUp);

    const arrowDown = document.createElement('img');
    arrowDown.src = `images/ui/${gameId}/${uiTheme}/arrowdown.png`;
    option.appendChild(arrowDown);

    container.appendChild(option);

    if (isAuto) {
      const autoLabel = document.createElement('label');
      autoLabel.dataset.i18n = '[html]modal.uiTheme.auto';
      item.appendChild(autoLabel);
    }

    item.appendChild(container);

    return item;
  }
  
  let uiThemeBgColors = {};
  let uiThemeFontShadows = {};
  let uiThemeFontColors = {};
  
  function getFontColor(uiTheme, fontStyle, callback) {
    if (!uiThemeFontColors[uiTheme])
      uiThemeFontColors[uiTheme] = {};
    let pixel = uiThemeFontColors[uiTheme][fontStyle];
    if (pixel)
      return callback('rgba(' + pixel[0] + ', ' + pixel[1] + ', ' + pixel[2] + ', 1)');
    const img = new Image();
    img.onload = function () {
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      context.drawImage(img, 0, 0);
      pixel = context.getImageData(0, 8, 1, 1).data;
      uiThemeFontColors[uiTheme][fontStyle] = [ pixel[0], pixel[1], pixel[2] ];
      callback('rgba(' + pixel[0] + ', ' + pixel[1] + ', ' + pixel[2] + ', 1)');
      canvas.remove();
    };
    img.src = 'images/ui/' + gameId + (hasUiThemes ? '/' + uiTheme : '') + '/font' + (fontStyle + 1) + '.png';
  }

  function getFontShadow(uiTheme, callback) {
    let pixel = uiThemeFontShadows[uiTheme];
    if (pixel)
      return callback('rgba(' + pixel[0] + ', ' + pixel[1] + ', ' + pixel[2] + ', 1)');
    const img = new Image();
    img.onload = function () {
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      context.drawImage(img, 0, 0);
      pixel = context.getImageData(0, 8, 1, 1).data;
      uiThemeFontShadows[uiTheme] = [ pixel[0], pixel[1], pixel[2] ];
      callback('rgba(' + pixel[0] + ', ' + pixel[1] + ', ' + pixel[2] + ', 1)');
      canvas.remove();
    };
    img.src = 'images/ui/' + gameId + (hasUiThemes ? '/' + uiTheme : '') + '/fontshadow.png';
  }

  function getBaseBgColor(uiTheme, callback) {
    const img = new Image();
    let pixel = uiThemeBgColors[uiTheme];
    if (pixel)
      return callback('rgba(' + pixel[0] + ', ' + pixel[1] + ', ' + pixel[2] + ', 1)');
    img.onload = function () {
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      context.drawImage(img, 0, 0);
      pixel = context.getImageData(0, 0, 1, 1).data;
      const pixel2 = context.getImageData(4, 4, 1, 1).data;
      const pixel3 = context.getImageData(8, 8, 1, 1).data;
      const r = Math.round((pixel[0] + pixel2[0] + pixel3[0]) / 3);
      const g = Math.round((pixel[1] + pixel2[1] + pixel3[1]) / 3);
      const b = Math.round((pixel[2] + pixel2[2] + pixel3[2]) / 3);
      uiThemeBgColors[uiTheme] = [ r, g, b ];
      callback('rgba(' + r + ', ' + g + ', ' + b + ', 1)');
      canvas.remove();
    };
    img.src = 'images/ui/' + gameId + (hasUiThemes ? '/' + uiTheme : '') + '/containerbg.png';
  }

  function handleSaveFileUpload(evt) {
    const save = evt.target.files[0];

    if (!/^Save\d{2}\.lsd$/.test(save.name)) {
      alert(localizedMessages.io.upload.invalidSaveFile);
      document.getElementById('uploadButton').click();
      return;
    }

    const saveSlot = getSaveSlot();

    if (saveSlot == null)
      return;

    const request = indexedDB.open(`/easyrpg/${gameId}/Save`);

    request.onsuccess = function (e) {

      const reader = new FileReader();
      let readerResult;

      reader.onload = function (file) {
        readerResult = file.currentTarget.result;
        const saveFile = { timestamp: new Date(), mode: 33206, contents: new Uint8Array(readerResult) };
    
        const db = request.result; 
        const transaction = db.transaction(['FILE_DATA'], 'readwrite');
        transaction.objectStore('FILE_DATA').put(saveFile, `/easyrpg/${gameId}/Save/Save${saveSlot}.lsd`);

        window.location = window.location;
      };

      reader.readAsArrayBuffer(save);
    };
  }

  function handleSaveFileDownload() {
    const request = indexedDB.open(`/easyrpg/${gameId}/Save`);

    request.onsuccess = function (e) {
      const saveSlot = getSaveSlot(true);

      if (saveSlot == null)
        return;

      const db = request.result; 
      const transaction = db.transaction(['FILE_DATA'], 'readwrite');
      const objectStore = transaction.objectStore('FILE_DATA');
      const objectStoreRequest = objectStore.get(`/easyrpg/${gameId}/Save/Save${saveSlot}.lsd`);

      objectStoreRequest.onsuccess = function (event) {
        const record = objectStoreRequest.result;

        if (!record) {
          alert(localizedMessages.io.download.emptySlot);
          return;
        }

        const blob = new Blob([record.contents], {type: 'text/json'});
        const link = document.createElement('a');
        link.href = window.URL.createObjectURL(blob);
        link.download = `Save${saveSlot}.lsd`;
        link.click();
        link.remove();
      };
    };
  }

  function getSaveSlot(download) {
    let fileIndex = prompt(localizedMessages.io[download ? 'download' : 'upload'].slotInput, 1);
    let fileIndexInt;

    while (fileIndex != null && !/^\d+$/.test(fileIndex) || (fileIndexInt = parseInt(fileIndex)) < 1 || fileIndexInt > 15)
      fileIndex = prompt(localizedMessages.io.common.failedSlotInput);

    if (fileIndex == null)
      return null;

    return fileIndexInt < 10 ? `0${fileIndexInt}` : fileIndexInt.toString();
  }

  function initLocalization(isInitial) {
    if (isInitial && gameId === '2kki') {
      const uiThemeOptions = document.querySelectorAll('.uiTheme option');
      for (let option of uiThemeOptions)
        option.setAttribute('data-i18n', `[html]uiTheme.values.2kki.${option.value}`);
    }
    document.getElementsByTagName('html')[0].lang = config.lang;
    fetch(`lang/${config.lang}.json`)
      .then(function (response) {
        return response.json();
      })
      .then(function (jsonResponse) {
        const version = jsonResponse.version[gameId];
        if (version) {
          const versionElement = document.querySelector('.version');
          const versionMeta = document.querySelector(`meta[name="${gameId}Version"]`);
          if (versionElement && versionMeta) {
            const substituteKeys = Object.keys(version.substitutes);
            let versionLabel = version.label.replace('{VERSION}', versionMeta.content || '?');
            for (let sk of substituteKeys)
              versionLabel = versionLabel.replace(sk, version.substitutes[sk]);
            versionElement.innerHTML = getMassagedLabel(versionLabel);
          }
        }

        massageLabels(jsonResponse.ui);

        const uiThemeLabels = jsonResponse.labels.uiTheme;
        const uiThemes = document.querySelectorAll('.uiTheme');
        for (let uiTheme of uiThemes)
          uiTheme.title = uiThemeLabels.hasOwnProperty(gameId) && uiThemeLabels[gameId].hasOwnProperty(uiTheme.dataset.uiTheme)
            ? uiThemeLabels[gameId][uiTheme.dataset.uiTheme]
            : '';

        localizedMessages = jsonResponse.messages;
        
        if (isInitial) {
          onUpdateConnectionStatus(0);
          updatePlayerCount('?');
        } else {
          if (connStatus !== undefined)
            onUpdateConnectionStatus(connStatus);
          if (playerCount !== undefined)
            updatePlayerCount(playerCount);
        }

        const resourcesJson = {};
        resourcesJson[config.lang] = { translation: jsonResponse.ui };
        i18next.init({
          lng: config.lang,
          resources: resourcesJson,
          preventValueFromContent: false
        }, function (err, t) {
          if (err)
            console.error(err);
          locI18next.init(i18next)('[data-i18n]');
        });
      });
  }

  function massageLabels(data) {
    if (langLabelMassageFunctions.hasOwnProperty(config.lang) && data) {
      Object.keys(data).forEach(function (key) {
        const value = data[key];
        if (value) {
          switch (typeof value) {
            case 'object':
              massageLabels(value);
              break;
            case 'string':
              data[key] = getMassagedLabel(value, true);
              break;
          }
        }
      });
    }
  }

  function getMassagedLabel(label, isUI) {
    if (langLabelMassageFunctions.hasOwnProperty(config.lang) && label)
      return langLabelMassageFunctions[config.lang](label, isUI);
    return label;
  }

  let loadedUiTheme = false;
  let loadedFontStyle = false;
  
  function loadOrInitConfig() {
    try {
      const configKey = `config_${gameId}`;
      if (!window.localStorage.hasOwnProperty(configKey))
        window.localStorage.setItem(configKey, JSON.stringify(config));
      else {
        const savedConfig = JSON.parse(window.localStorage.getItem(configKey));
        const savedConfigKeys = Object.keys(savedConfig);
        for (let k in savedConfigKeys) {
          const key = savedConfigKeys[k];
          if (config.hasOwnProperty(key)) {
            let value = savedConfig[key];
            switch (key) {
              case 'lang':
                document.getElementById('lang').value = value;
                setLang(value, true);
                break;
              case 'name':
                document.getElementById('nameInput').value = value;
                setName(value, true);
                break;
              case 'uiTheme':
                if (hasUiThemes && gameUiThemes.indexOf(value) > -1) {
                  if (hasUiThemes)
                    document.querySelector('.uiTheme').value = value;
                  setUiTheme(value, true);
                  loadedUiTheme = true;
                }
                break;
              case 'fontStyle':
                if (hasUiThemes && gameUiThemes.indexOf(value) > -1) {
                  document.querySelector('.fontStyle').value = value;
                  setFontStyle(value, true);
                  loadedFontStyle = true;
                }
                break;
              case 'locationCache':
                locationCache = Object.assign({}, value);
                break;
              case 'mapCache':
                mapCache = Object.assign({}, value);
                break;
            }
            config[key] = value;
          }
        }
      }
    } catch (error) {
      console.error(error);
    }
  }
  
  function updateConfig(config) {
    try {
      window.localStorage[`config_${gameId}`] = JSON.stringify(config);
    } catch (error) {
    }
  }

  onResize();
  
  loadOrInitConfig();

  if (!loadedFontStyle)
    setFontStyle(0, true);
  if (!loadedUiTheme)
    setUiTheme(hasAutoUiTheme ? 'auto' : getDefaultUiTheme(), true);
  if (!localizedMessages)
    initLocalization(true);
</script>

</body>
</html>
