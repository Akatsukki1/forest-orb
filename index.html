<!doctype html>
<html lang="en">
<head>
  <title>Yume Nikki Online Project</title>
  <meta charset="utf-8">
  <meta name="description" content="Play Yume Nikki (and fangames) online with your friends, no downloads required.">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="2kkiVersion" content="" data-game-ids="2kki"> <!-- eg. 0.117g Patch 4 -->
  <link rel="stylesheet" href="play.css">
  <style>
    :root {
      --color-gray: hsl(0, 0%, 55%);
      --controls-size: 10vh;
    }

    @media (orientation: landscape) {
      :root {
        --controls-size: 20vh;
      }
    }

    html {
      touch-action: none;
    }

    .unselectable {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }

    #status {
      font-size: 1.5rem;
      color: var(--color-gray);
      text-align: center;
    }

    #gameContainer {
      width: 100%;
      height: 100%;
    }

    #dpad, #apad {
      position: fixed;
      bottom: 1rem;
      z-index: 3;
    }

    #dpad {
      left: 1rem;
    }

    #apad {
      right: 1rem;
    }

    #dpad svg {
      width: calc(2 * var(--controls-size));
      height: calc(2 * var(--controls-size));
      fill: var(--color-gray);
    }

    #dpad svg rect {
      opacity: 0.4;
    }

    #apad > * {
      width: var(--controls-size);
      height: var(--controls-size);
      background-color: var(--color-gray);
      border-radius: 50%;
    }

    #apad > :last-child {
      position: relative;
      right: var(--controls-size);
    }

    #dpad path:not(.active), #apad > *:not(.active) {
      opacity: 0.4;
    }

    @media (hover: hover) and (pointer: fine) {
      #apad, #dpad {
        display: none;
      }
    }

    #layout:fullscreen #dpad, #layout:fullscreen #apad {
      bottom: 6rem;
    }
  </style>
  <style id="themeStyles">
    html, input[type='text'], select {
      color: rgba(216, 216, 216, 1) !important; /*base*/
      background-color: black;
    }

    body, .container, div, input[type='text'], #ioControls .button {
      image-rendering: crisp-edges;
      image-rendering: pixelated;
    }

    body {
      background-size: 210px;
      background-position-y: -16px;
      background-image: url('images/ui/yume/Default/containerbg.png') !important;
    }
    
    body.fullBg {
      background-size: 100%;
    }

    #layout::-webkit-scrollbar-track, #messages::-webkit-scrollbar-track {
      border: 8px solid transparent;
      border-image: url('images/ui/yume/Default/border.png') 8 repeat !important;
      background-color: rgba(45, 17, 23, 1); /*basebg*/
      image-rendering: crisp-edges;
      image-rendering: pixelated;
    }

    #layout::-webkit-scrollbar-thumb, #messages::-webkit-scrollbar-thumb {
      border: 8px solid transparent;
      border-image: url('images/ui/yume/Default/border.png') 6 round !important;
      image-rendering: crisp-edges;
      image-rendering: pixelated;
    }

    #controls button path {
      stroke: rgba(216, 216, 216, 1) !important; /*base*/
    }

    #messages, #chatInputContainer, #enterNameContainer {
      border: 8px solid transparent;
    }
  
    #messages, #enterNameContainer {
      border-image: url('images/ui/yume/Default/border.png') 10 repeat !important;
    }
  
    #enterNameInstruction, .notice, .instruction, .message, a, label {
      background-image: url('images/ui/yume/Default/font1.png') !important; /*base*/
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      filter: drop-shadow(1.5px 1.5px black /*shadow*/);
    }

    a {
      background-image: url('images/ui/yume/Default/font4.png') !important; /*alt*/
    }
  
    .messageContainer {
      border-bottom: 4px solid transparent;
      border-image: url('images/ui/yume/Default/border.png') 8 repeat !important;
    }

    .container {
      background-size: 70px;
      background-position-y: -16px;
      background-image: url('images/ui/yume/Default/containerbg.png') !important;
      border-image: url('images/ui/yume/Default/border.png') 10 repeat !important;
      border: 24px solid transparent;
    }

    .container.fullBg {
      background-size: 650px;
    }

    #layout.downscale .container.fullBg {
      background-size: 530px;
    }

    #layout.downscale2 .container.fullBg {
      background-size: 410px;
    }
  
    input[type='text'], select, #ioControls button {
      border: 12px solid transparent;
      border-image: url('images/ui/yume/Default/border.png') 8 repeat !important;
      color: rgba(216, 216, 216, 1) !important; /*base*/
      background-color: rgba(45, 17, 23, 1) !important; /*basebg*/
      text-shadow: 1.5px 1.5px black; /*shadow*/
    }

    #ioControls {
      display: flex;
      justify-content: center;
    }

    #ioControls button {
      z-index: 1;
    }

    #ioControls button:not(:last-child) {
      margin-right: 32px;
    }
  </style>
  <style data-game-ids="2kki">
    #location {
      display: flex;
      padding-bottom: 8px;
      white-space: nowrap;
    }

    #location.hidden {
      display: none;
    }

    #locationText {
      width: 100%;
      text-align: center;
      word-break: keep-all;
      letter-spacing: 0;
      word-spacing: 0;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/i18next@21.6.4/dist/umd/i18next.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/loc-i18next@0.1.4/dist/umd/loc-i18next.min.js"></script>
</head>
<body>
  <div id="background"></div>
  <div id="content">
    <div id="layout">
      <div id="mainContainer" class="container">
        <div id="gameContainer">
            <div id="controls">
              <div id="mapControls"></div>
              <button id="controls-fullscreen" class="unselectable">
                <svg viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg" width="25" height="25"><path d="M13.5 13.5H10m3.5 0V10m0 3.5l-4-4m.5-8h3.5m0 0V5m0-3.5l-4 4M5 1.5H1.5m0 0V5m0-3.5l4 4m-4 4.5v3.5m0 0H5m-3.5 0l4-4"></path></svg>
              </button>
            </div>

            <div id="status"></div>

            <div id="canvasContainer">
              <canvas id="canvas" tabindex="-1"></canvas>
            </div>

            <div id="dpad" class="unselectable">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 72 72">
                <path id="dpad-up" data-key="ArrowUp" data-key-code="38" d="M48,5.8C48,2.5,45.4,0,42,0H29.9C26.6,0,24,2.4,24,5.8V24h24V5.8z" />
                <path id="dpad-right" data-key="ArrowRight" data-key-code="39" d="M66.2,24H48v24h18.2c3.3,0,5.8-2.7,5.8-6V29.9C72,26.5,69.5,24,66.2,24z" />
                <path id="dpad-down" data-key="ArrowDown" data-key-code="40" d="M24,66.3c0,3.3,2.6,5.7,5.9,5.7H42c3.3,0,6-2.4,6-5.7V48H24V66.3z" />
                <path id="dpad-left" data-key="ArrowLeft" data-key-code="37" d="M5.7,24C2.4,24,0,26.5,0,29.9V42c0,3.3,2.3,6,5.7,6H24V24H5.7z" />
                <rect id="dpad-center" x="24" y="24" width="24" height="24" />
              </svg>
            </div>

            <div id="apad" class="unselectable">
              <div id="apad-escape" data-key="Escape" data-key-code="27"></div>
              <div id="apad-enter" data-key="Enter" data-key-code="13"></div>
            </div>
        </div>
        
        <div id="uiControls">
          <div class="uiControl" data-game-ids="yume,2kki,flow,prayers,deepdreams,someday" style="display: none;">
            <label for="uiTheme" class="unselectable" data-i18n="[html]uiTheme.label">UI Theme:</label>
            <select class="uiTheme" data-game-ids="yume">
              <option value="Default">Default</option>
              <option value="Alternate_1" class="fullBg">Alternate 1</option>
              <option value="Alternate_2">Alternate 2</option>
            </select>
            <select class="uiTheme" data-game-ids="2kki">
              <option value="Default">Default</option>
              <option value="Default_2">Default 2</option>
              <option value="Default_3">Default 3</option>
              <option value="Default_4">Default 4</option>
              <option value="Default_5">Default 5</option>
              <option value="Developer_Room">Developer Room</option>
              <option value="Glitch_Ending">Bleak Future</option>
              <option value="Glitch_Ending_2">Bleak Future 2</option>
              <option value="Black_Building">Black Building</option>
              <option value="Cog_Maze">Cog Maze</option>
              <option value="Square_Square_World">Square-Square World</option>
              <option value="Verdant_Promenade">Verdant Promenade</option>
              <option value="Urotsukis_Dream_Apartments">Urotsuki's Dream Apartments</option>
              <option value="Sofa_Room">Sofa Room</option>
              <option value="Depths">Depths</option>
              <option value="Depths_2">Depths 2</option>
              <option value="Guts_World">Guts World</option>
              <option value="Maple_Shrine">Maple Shrine</option>
              <option value="Pencil_World">Pencil World</option>
              <option value="Chocolate_World">Chocolate World</option>
              <option value="Blue_Cactus_Islands">Blue Cactus Islands</option>
              <option value="Stone_Towers">Stone Towers</option>
              <option value="Constellation_World">Star Building</option>
              <option value="Blob_Desert">Blob Desert</option>
              <option value="Cipher_Keyboard">Cipher Keyboard</option>
              <option value="Viridian_Wetlands">Viridian Wetlands</option>
              <option value="Polluted_Swamp">Polluted Swamp</option>
              <option value="Snowy_Village">Snowy Village</option>
              <option value="Decrepit_Dwellings">Decrepit Dwellings</option>
              <option value="Verdant_Promenade_2">Verdant Promenade 2</option>
              <option value="Black_Ink_World">Black Ink World</option>
              <option value="Forgotten_Megalopolis">Forgotten Megalopolis</option>
              <option value="Tomb_of_Velleities">Tomb of Velleities</option>
              <option value="Visine_Spacecraft">Visine Spacecraft</option>
              <option value="Data_Stream">Data Stream</option>
              <option value="Lavender_Waters">Lavender Waters</option>
              <option value="Originator_Garden">Originator Garden</option>
              <option value="Fluorescent_Halls">Fluorescent Halls</option>
              <option value="City_of_Liars">City of Liars</option>
              <option value="Misc">Misc. Theme</option>
              <option value="Monochrome_GB_World">Monochrome GB World</option>
              <option value="Smiley_Signs_World">Smiley Signs World</option>
              <option value="Lovesick_World">Lovesick World</option>
              <option value="Corrupted_Love_World">Corrupted Love World</option>
              <option value="Saturated_Eyeball_Zone">Saturated Eyeball Zone</option>
              <option value="NES_Glitch_Tunnel">NES Glitch Tunnel</option>
              <option value="Shop_Ruins">Shop Ruins</option>
            </select>
            <select class="uiTheme" data-game-ids="flow">
              <option value="Default">Default</option>
              <option value="Famicom">Famicom</option>
              <option value="Dot">Dot</option>
              <option value="Orange">Orange</option>
              <option value="Flower">Flower</option>
              <option value="Sugar">Sugar</option>
              <option value="Rust">Rust</option>
              <option value="Smile">Smile</option>
            </select>
            <select class="uiTheme" data-game-ids="prayers">
              <option value="Default" class="fullBg">Default</option>
              <option value="Alternate_1" class="fullBg">Alternate 1</option>
              <option value="Alternate_2" class="fullBg">Alternate 2</option>
            </select>
            <select class="uiTheme" data-game-ids="deepdreams">
              <option value="Default">Default</option>
              <option value="Arabian">Arabian</option>
              <option value="Crystalline">Crystalline</option>
              <option value="Kaleidoscope">Kaleidoscope</option>
              <option value="Rainbow">Rainbow</option>
              <option value="Spider_Lily">Spider Lily</option>
            </select>
            <select class="uiTheme" data-game-ids="someday">
              <option value="Default">Default</option>
              <option value="8_Bit">8-Bit</option>
              <option value="Blue">Binary</option>
              <option value="Clock">Clock</option>
              <option value="Edible">Edible</option>
              <option value="Rainbow">Rainbow</option>
              <option value="311">Three-One-One</option>
              <option value="Turquoise">Turquoise</option>
            </select>
          </div>

          <div class="uiControl">
            <label for="fontStyle" class="unselectable" data-i18n="[html]fontStyle.label">Font Style:</label>
            <select id="fontStyle" class="fontStyle">
              <option value="0" data-i18n="[html]fontStyle.values.style1">Style 1</option>
              <option value="1" data-i18n="[html]fontStyle.values.style2">Style 2</option>
              <option value="2" data-i18n="[html]fontStyle.values.style3" data-game-ids="yume,2kki,flow,prayers,deepdreams,someday">Style 3</option>
              <option value="3" data-i18n="[html]fontStyle.values.style4" data-game-ids="yume,2kki,flow,prayers,someday">Style 4</option>
              <option value="4" data-i18n="[html]fontStyle.values.style5" data-game-ids="yume,2kki,flow">Style 5</option>
              <option value="5" data-i18n="[html]fontStyle.values.style6" data-game-ids="yume,2kki,flow">Style 6</option>
              <option value="6" data-i18n="[html]fontStyle.values.style7" data-game-ids="yume,2kki,flow">Style 7</option>
            </select>
          </div>
        </div>
      </div>
      <div id="chatboxContainer" class="container" style="display: none">
        <div id="chatbox">
          <div id="location" style="display: none" class="hidden" data-game-ids="2kki">
            <span data-i18n="[html]chatbox.location">Location:&nbsp;</span><span id="locationText"></span>
          </div>
          <div id="messages"></div>
          <div id="chatInputContainer" style="display: none">
            <form action="javascript:chatInputActionFired()">
              <input id="chatInput" type="text" autocomplete="off" maxlength="200" disabled="true" />
            </form>
          </div>
          <div id="enterNameContainer">
            <span id="enterNameInstruction">
              <span data-i18n="[html]chatbox.nickname.header">You must set a nickname before you can chat.</span>
              <br>
              <small>
                <span data-i18n="[html]chatbox.nickname.rule.maxLength">* Maximum 12 characters</span>
                <br>
                <span data-i18n="[html]chatbox.nickname.rule.alphanumeric">* Alphanumeric characters only</span>
              </small>
            </span>
            <form id="enterNameForm" action="javascript:chatNameCheck()">
              <input id="nameInput" type="text" autocomplete="off" maxlength="12"></input>
            </form>
          </div>
        </div>
      </div>
    </div>
  <br>
  <div class="instruction" data-i18n="[html]instruction.connStatusToggle">Press 3 to hide/show the connection status window</div>
  <div class="instruction" data-i18n="[html]instruction.nametagToggle">Press 4 to hide/show nametags</div>
  <div data-game-ids="2kki" style="display: none;">
    <br>
    <div class="notice version">Yume 2kki Version <span id="2kkiVersion"></span></div>
    <div class="notice" data-i18n="[html]2kki.hostedWithPermission">Hosted with permission from the Yume 2kki developers</div>
  </div>
  <br>
  <div id="ioControls">
    <button id="uploadButton" data-i18n="[html]io.upload">Upload Save File</button>
    <button id="downloadButton" data-i18n="[html]io.download">Download Save File</button>
  </div>
  <br>
  <div class="instruction"><a href="https://discord.gg/fRG3AxUeKN" data-i18n="[html]instruction.discord">Join our Discord!</a></div>
  <br>
  <div id="langContainer">
    <label for="lang" class="unselectable" data-i18n="[html]lang.label">Language:</label>
    <select id="lang">
      <option value="en">English</option>
      <option value="ja">日本語</option>
      <option value="es">Español</option>
      <option value="pt">Português</option>
      <option value="fr">Français</option>
      <option value="ru">Русский</option>
      <option value="zh">中文</option>
      <option value="kr">한국어</option>
    </select>
  </div>
  <div id="backgroundTransition"></div>
</div>
<script>
  const gameIds = ['yume', '2kki', 'flow', 'prayers', 'deepdreams', 'someday'];
  const gameIdMatch = new RegExp('(?:' + gameIds.join('|') + ')').exec(window.location);
  const gameId = gameIdMatch ? gameIdMatch[0] : gameIds[0];
  Module = {
    EASYRPG_GAME: gameId,
    EASYRPG_WS_URL: 'wss://ynoproject.net/connect/' + gameId + '/'
  };
</script>
<script type="text/javascript" src="index.js"></script>
<script type="text/javascript" src="chat.js"></script>

<script>
const hasTouchscreen = window.matchMedia('(hover: none), (pointer: coarse)').matches;
const preventNativeKeys = ['ArrowUp', 'ArrowDown', 'ArrowRight', 'ArrowLeft', ' ', 'F12'];
const keys = new Map();
const keysDown = new Map();
const canvas = document.getElementById('canvas');
const gameContainer = document.getElementById('gameContainer');
let lastTouchedId;

// Make EasyRPG player embeddable
gameContainer.addEventListener('mouseenter', () => canvas.focus());
gameContainer.addEventListener('click', () => canvas.focus());

// Handle clicking on the fullscreen button
document.querySelector('#controls-fullscreen').addEventListener('click', () => {
  const layout = document.getElementById('layout');
  if (layout.requestFullscreen) {
    if (!document.fullscreenElement)
      layout.requestFullscreen();
    else
      document.exitFullscreen();
  }
});

/**
 * Simulate a keyboard event on the emscripten canvas
 *
 * @param {string} eventType Type of the keyboard event
 * @param {string} key Key to simulate
 * @param {number} keyCode Key code to simulate (deprecated)
 */
function simulateKeyboardEvent(eventType, key, keyCode) {
  const event = new Event(eventType, { bubbles: true });
  event.key = key;
  event.code = key;
  // Deprecated, but necessary for emscripten somehow
  event.keyCode = keyCode;
  event.which = keyCode;

  canvas.dispatchEvent(event);
}

/**
 * Simulate a keyboard input from `keydown` to `keyup`
 *
 * @param {string} key Key to simulate
 * @param {number} keyCode Key code to simulate (deprecated)
 */
function simulateKeyboardInput(key, keyCode) {
  simulateKeyboardEvent('keydown', key, keyCode);
  window.setTimeout(() => {
    simulateKeyboardEvent('keyup', key, keyCode);
  }, 100);
}

/**
 * Bind a node by a specific key to simulate on touch
 *
 * @param {*} node The node to bind a key to
 * @param {string} key Key to simulate
 * @param {number} keyCode Key code to simulate (deprecated)
 */
function bindKey(node, key, keyCode) {
  keys.set(node.id, { key, keyCode });

  node.addEventListener('touchstart', event => {
    event.preventDefault();
    simulateKeyboardEvent('keydown', key, keyCode);
    keysDown.set(event.target.id, node.id);
    node.classList.add('active');
  });

  node.addEventListener('touchend', event => {
    event.preventDefault();

    const pressedKey = keysDown.get(event.target.id);
    if (pressedKey && keys.has(pressedKey)) {
      const { key, keyCode } = keys.get(pressedKey);
      simulateKeyboardEvent('keyup', key, keyCode);
    }

    keysDown.delete(event.target.id);
    node.classList.remove('active');
  
    if (lastTouchedId) {
      document.getElementById(lastTouchedId).classList.remove('active');
    }
  });

  // Inspired by https://github.com/pulsejet/mkxp-web/blob/262a2254b684567311c9f0e135ee29f6e8c3613e/extra/js/dpad.js
  node.addEventListener('touchmove', event => {
    const { target, clientX, clientY } = event.changedTouches[0];
    const origTargetId = keysDown.get(target.id);
    const nextTargetId = document.elementFromPoint(clientX, clientY).id;
    if (origTargetId === nextTargetId) return;

    if (origTargetId) {
      const { key, keyCode } = keys.get(origTargetId);
      simulateKeyboardEvent('keyup', key, keyCode);
      keysDown.delete(target.id);
      document.getElementById(origTargetId).classList.remove('active');
    }

    if (keys.has(nextTargetId)) {
      const { key, keyCode } = keys.get(nextTargetId);
      simulateKeyboardEvent('keydown', key, keyCode);
      keysDown.set(target.id, nextTargetId);
      lastTouchedId = nextTargetId;
      document.getElementById(nextTargetId).classList.add('active');
    }
  })
}

// Bind all elements providing a `data-key` attribute with the
// given key on touch-based devices
if (hasTouchscreen) {
  for (const button of document.querySelectorAll('[data-key]')) {
    bindKey(button, button.dataset.key, button.dataset.keyCode);
  }
} else {
  // Prevent scrolling when pressing specific keys
  canvas.addEventListener('keydown', event => {
    if (preventNativeKeys.includes(event.key)) {
      event.preventDefault();
    }
  });

  canvas.addEventListener('contextmenu', event => {
    event.preventDefault();
    // simulateKeyboardInput('Escape', 27);
  });

  // canvas.addEventListener('click', () => {
  //   simulateKeyboardInput('Enter', 13);
  // });
}
</script>
<script data-game-ids="2kki">
  const is2kki = gameId === '2kki';
  let cachedMapId = null;
  let cachedLocationLink = null;
  let cachedLocationName = null;
  const queryingLocationLabels = {
    'en': 'Querying Location...',
    'ja': 'Querying Location...', // Keep English translation by recommendation of qxy
    'es': 'Buscando Ubicación...',
    'pt': 'Procurando Localização...',
    'fr': 'Récupération du Lieu...',
    'ru': 'Вычисляем место нахождения...',
    'zh': '正在查询地点...',
    'kr': '위치 검색 중...'
  };
  const locationNamePattern = /^<a .*?>(.*?)<\/a>/;
  const unknownLocations = [];
  const ignoredMapIds = ['0899', '0900'];
  let defaultLocationLinks;

  // called from EasyRPG player
  function onLoadMap(mapName) {
    if (gameId !== '2kki')
      return;
    let mapIdMatch = /^Map(\d{4})\.lmu$/.exec(mapName);
    if (mapIdMatch) {
      const mapId = mapIdMatch[1];

      if (mapId === cachedMapId || ignoredMapIds.indexOf(mapId) > -1)
        return;

      const locationKey = `${(cachedMapId || '0000')}_${mapId}`;

      let locationLink = locationCache[locationKey] || null;

      const useDefaultLocation = defaultLocationLinks.hasOwnProperty(mapId);

      if (useDefaultLocation)
        locationLink = defaultLocationLinks[mapId];
      else if (Object.values(queryingLocationLabels).indexOf(locationLink) > -1)
        locationLink = null;
      else if (unknownLocations.indexOf(locationKey) > -1)
        locationLink = localizedMessages.location.unknownLocation;

      if (!cachedMapId)
        document.getElementById('location').classList.remove('hidden');
      
      if (locationLink) {
        const cacheLocation = useDefaultLocation && !locationCache.hasOwnProperty(locationKey);
        const locationNameResult = locationNamePattern.exec(locationLink);
        const locationName = locationNameResult ? locationNameResult[1] : null;
        setLocation(mapId, cachedMapId, locationLink, cachedLocationLink, cacheLocation);
        cachedMapId = mapId;
        cachedLocationLink = locationLink;
        cachedLocationName = locationName;
        if (mapCache.hasOwnProperty(locationName))
          setMaps(mapCache[locationName], locationName);
        else if (useDefaultLocation) {
          const cacheMap = useDefaultLocation && !mapCache.hasOwnProperty(locationName);
          setMaps([], locationName, cacheMap, cacheMap);
        } else
          queryAndSetMaps(locationName);
      } else {
        queryAndSetLocation(mapId, cachedMapId, cachedLocationLink, cachedLocationName)
          .then(locationName => {
            if (locationName)
              queryAndSetMaps(locationName);
            else
              setMaps([], true, true);
          }).catch(err => console.error(err));
      }
    }
  }
  
  function queryAndSetLocation(mapId, prevMapId, prevLocationLink, prevLocationName) {
    return new Promise((resolve, reject) => {
      const req = new XMLHttpRequest();
        let url = `https://2kki.app/getMapLocationNames?mapId=${mapId}`;
        if (prevMapId) {
            url += `&prevMapId=${prevMapId}`;
            if (prevLocationName)
              url += `&prevLocationName=${prevLocationName}`;
        }
        req.responseType = 'json';
        req.open("GET", url);
        req.send();

        setLocation(mapId, prevMapId, queryingLocationLabels[config.lang], prevLocationLink, true);

        req.onload = (e) => {
          const locationsArray = req.response;
          let locationName = null;

          if (Array.isArray(locationsArray) && locationsArray.length) {
            let location = locationsArray[0];
            if (locationsArray.length > 1 && prevLocationLink) {
              for (let l of locationsArray) {
                if (getLocationLink(l) === prevLocationLink) {
                  location = l;
                  break;
                }
              }
            }
            setLocation(mapId, prevMapId, getLocationLink(location), prevLocationLink, true, true);
            locationName = location.title;
          } else {
            if (prevMapId) {
              queryAndSetLocation(mapId, null, null, null).then(() => resolve(null)).catch(err => reject(err));
              return;
            }
            setLocation(mapId, prevMapId, null, prevLocationLink, true, true);
          }

          cachedMapId = mapId;
          cachedLocationLink = document.getElementById('locationText').innerHTML;
          cachedLocationName = locationName;
          resolve(locationName);
        };
    });
  }

  function setLocation(mapId, prevMapId, locationLink, prevLocationLink, cacheLocation, saveLocation) {
    document.getElementById('locationText').innerHTML = locationLink || localizedMessages.location.unknownLocation;
    if (cacheLocation) {
      const locationKey = `${(prevMapId || '0000')}_${mapId}`;
      const prevLocationKey = `${mapId}_${(prevMapId || '0000')}`;
      if (locationLink)
        locationCache[locationKey] = locationLink;
      else
        unknownLocations.push(locationKey)
      if (prevLocationLink)
        locationCache[prevLocationKey] = prevLocationLink;
      if (saveLocation && (locationLink || prevLocationLink)) {
        if (locationLink)
          config.locationCache[locationKey] = locationLink;
        if (prevLocationLink)
          config.locationCache[prevLocationKey] = prevLocationLink;
        updateConfig(config);
      }
    }
  }

  function getLocationLink(location, urlTitle, urlTitleJP) {
    if (!urlTitle)
      urlTitle = location.title;
    if (!urlTitleJP)
      urlTitleJP = (location.titleJP.indexOf("：") > -1 ? location.titleJP.slice(0, location.titleJP.indexOf("：")) : location.titleJP);
    const url = `https://yume2kki.fandom.com/wiki/${urlTitle}`;
    const urlJP = `https://wikiwiki.jp/yume2kki-t/${urlTitleJP}`;
    return `<a href="${url}" target="_blank">${location.title}</a> (<a href="${urlJP}" target="_blank">${location.titleJP}</a>)`;
  }

  function getDefaultLocationLinks() {
    const ret = {
      '0150': getLocationLink({ title: 'Puzzle Game (Kura Puzzle)', titleJP: 'パズルゲーム' }, 'Console#PUZZLE_GAME_.28Kura_Puzzle.29', 'ミニゲーム/パズルゲーム'),
      '0620': getLocationLink({ title: 'Sound Room', titleJP: 'SR分室の曲' }, 'Soundtrack', '収集要素/SR分室の曲・演出の解放条件')
    };

    const wavyUpLocationLink = getLocationLink({ title: '↑v↑ (Wavy Up)', titleJP: '↑v↑'}, 'Console#.E2.86.91V.E2.86.91_.28Wavy_Up.29', 'ミニゲーム/↑v↑');
    for (let i = 121; i <= 130; i++)
      ret[`0${i}`] = wavyUpLocationLink;

    const platedSnowCountryLink = getLocationLink({ title: 'Plated Snow Country', titleJP: 'ゆきぐにっき'}, 'Console#Plated_Snow_Country', 'ミニゲーム/ゆきぐにっき');
    for (let i = 249; i <= 250; i++)
      ret[`0${i}`] = platedSnowCountryLink;

    return ret;
  }

  function queryAndSetMaps(locationName) {
    return new Promise((resolve, reject) => {
      const req = new XMLHttpRequest();
        let url = `https://2kki.app/getLocationMaps?locationName=${locationName}`;
        req.responseType = 'json';
        req.open("GET", url);
        req.send();

        setMaps([], true);

        req.onload = (e) => {
          const mapsArray = req.response;

          if (Array.isArray(mapsArray))
            setMaps(mapsArray, locationName, true, true);

          resolve();
        };
    });
  }

  function setMaps(maps, locationName, cacheMaps, saveMaps) {
    const mapControls = document.getElementById('mapControls');
    mapControls.innerHTML = '';
    if (maps && maps.length) {
      for (let map of maps)
        mapControls.appendChild(getMapButton(map.url, map.label));
    }
    if (cacheMaps && locationName) {
      mapCache[locationName] = maps;
      if (saveMaps) {
        config.mapCache[locationName] = maps;
        updateConfig(config);
      }
    }
  }

  function getMapButton(url, label) {
    const ret = document.createElement('button');
    ret.classList.add('mapButton');
    ret.classList.add('unselectable');
    ret.title = label;
    ret.onclick = () => {
      const handle = window.open(url, '_blank', 'noreferrer');
      if (handle)
          handle.focus();
    };
    ret.innerHTML = '<svg viewbox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" width="24" height="24"><path d="m0 0l6 3 6-3 6 3v15l-6-3-6 3-6-3v-15m6 3v15m6-18v15"></path></svg>';
    return ret;
  }

  if (is2kki)
    defaultLocationLinks = getDefaultLocationLinks();
</script>
<script>
  const gameIdsElements = document.querySelectorAll('[data-game-ids]');
  for (let el of gameIdsElements) {
    if (el.dataset.gameIds.split(',').indexOf(gameId) > -1)
      el.style.display = '';
    else
      el.remove();
  }

  let localizedMessages;

  const hasUiThemes = !!document.querySelector('.uiTheme');

  let config = {
    lang: document.referrer && /\.jp/.test(document.referrer) ? 'ja' : 'en',
    name: ''
  };

  let locationCache;

  document.getElementById('lang').onchange = function () {
    setLang(this.value);
  };

  if (hasUiThemes) {
    config.uiTheme = 'Default';

    const uiTheme = document.querySelector('.uiTheme');
    uiTheme.onchange = function () {
      setUiTheme(this.value);
    };
    // Set ID so the associated label will be attached
    uiTheme.id = 'uiTheme';
  }

  config.fontStyle = 0;

  document.querySelector('.fontStyle').onchange = function () {
    setFontStyle(parseInt(this.value));
  };

  document.getElementById('enterNameForm').onsubmit = function () {
    setName(this.value);
  };

  document.getElementById('uploadButton').onclick = function () {
    let saveFile = document.getElementById('saveFile');
    if (saveFile)
      saveFile.remove();

    saveFile = document.createElement('input');
    saveFile.type = 'file';
    saveFile.id = 'saveFile';
    saveFile.style.display = 'none';
    saveFile.addEventListener('change', handleSaveFileUpload);
    saveFile.click();
  };

  document.getElementById('downloadButton').onclick = handleSaveFileDownload;

  if (gameId === '2kki') {
    document.getElementById('2kkiVersion').innerText = document.querySelector('meta[name="2kkiVersion"]').content || '?';
    locationCache = {};
    mapCache = {};
    config.locationCache = {};
    config.mapCache = {};
  }

  let ignoreSizeChanged = false;

  function onResize() {
    const layout = document.getElementById('layout');
    const canvas = document.getElementById('canvas');

    const downscale = window.innerWidth < 704 || window.innerHeight < 577;
    const downscale2 = window.innerWidth < 544 || window.innerHeight < 457;

    document.getElementById('mainContainer').classList.toggle('noSideBorders', window.innerWidth < 384);

    if (window.innerWidth < window.innerHeight) {
      layout.classList.toggle('downscale', downscale);
      layout.classList.toggle('downscale2', downscale2);
      layout.classList.toggle('overflow', isOverflow(downscale2 ? 0.5 : downscale ? 0.75 : 1));
    } else {
      const overflow = isOverflow();
      if (overflow !== isOverflow(0.75)) {
        layout.classList.toggle('downscale', downscale || overflow);
        layout.classList.remove('downscale2');
        layout.classList.toggle('overflow', !overflow);
      } else if (overflow !== isOverflow(0.5)) {
        layout.classList.toggle('downscale', downscale || overflow);
        layout.classList.toggle('downscale2', downscale2 || overflow);
        layout.classList.toggle('overflow', !overflow);
      } else {
        layout.classList.toggle('downscale', downscale);
        layout.classList.toggle('downscale2', downscale2);
        layout.classList.toggle('overflow', overflow);
      }
    }

    updateCanvasFullscreenSize();
  }

  function isOverflow(scale) {
    return window.innerWidth < 984 && window.innerHeight <= 594 && (window.innerWidth <= 704 || document.getElementById('gameContainer').offsetWidth < (640 * (scale || 1)) + (document.getElementById('layout').classList.contains('overflow') ? 288 : 0));
  }

  function updateCanvasFullscreenSize() {
    const canvasElement = document.getElementById('canvas');
    const canvasContainerElement = document.getElementById('canvasContainer');
    const chatboxContainerElement = document.getElementById('chatboxContainer');

    let canvasContainerHeight = null;
    let canvasContainerPaddingRight = null;
    let canvasContainerMarginTop = null;
    let chatboxContainerMarginTop = null;
    let chatboxHeight = null;
    let chatboxOverlap = false;
    
    if (document.fullscreenElement) {
      let scaleX = window.innerWidth / canvasElement.offsetWidth;
      let scaleY = window.innerHeight / canvasElement.offsetHeight;
      const scaleFraction = document.getElementById('layout').classList.contains('downscale') ? 0.25 : 0.5;
      scaleX -= scaleX % scaleFraction;
      scaleY -= scaleY % scaleFraction;
      const scale = Math.max(Math.min(scaleX, scaleY), 0.5);
      canvasElement.style.transform = `scale(${scale})`;

      if (window.innerWidth > 1050 || window.innerHeight < 595) {
        const chatboxContainerWidth = chatboxContainerElement.offsetWidth - 24;
        chatboxContainerMarginTop = '24px';
        if (chatboxContainerWidth + 48 <= window.innerWidth - (canvasElement.offsetWidth * scale))
          canvasContainerPaddingRight = `${chatboxContainerWidth}px`;
        else
          chatboxOverlap = true;
      } else {
        const canvasScaledHeight = canvasElement.offsetHeight * scale;
        const unusedHeight = window.innerHeight - (canvasScaledHeight + 32);
        if (unusedHeight >= 376) {
          canvasContainerMarginTop = `-${(window.innerHeight - canvasScaledHeight) / 2}px`
          chatboxContainerMarginTop = `${(window.innerHeight - unusedHeight) - 40}px`;
          chatboxHeight = `${unusedHeight}px`;
        } else {
          chatboxContainerMarginTop = '24px';
          chatboxOverlap = true;
        }
      }
    } else {
      canvasElement.style.transform = null;
      canvasContainer.style.paddingRight = null;
    }

    canvasContainerElement.style.height = canvasContainerHeight;
    canvasContainerElement.style.paddingRight = canvasContainerPaddingRight;
    canvasContainerElement.style.marginTop = canvasContainerMarginTop;
    chatboxContainerElement.style.marginTop = chatboxContainerMarginTop;
    chatboxContainerElement.classList.toggle('overlap', chatboxOverlap);
    document.getElementById('chatbox').style.height = chatboxHeight;

    document.getElementById("messages").scrollTop = messages.scrollHeight;
  }

  if (Module.postRun)
    Module.postRun.push(onResize);
  window.onresize = function () { window.setTimeout(onResize, 0); };

  document.addEventListener('fullscreenchange', updateCanvasFullscreenSize);
  
  window.onbeforeunload = function () {
    return localizedMessages.leavePage;
  };

  function setLang(lang, isInit) {
    config.lang = document.getElementById('lang').value;
    initLocalization(isInit);
    if (!isInit)
      updateConfig(config);
  }
  
  function setName(name, isInit) {
    config.name = document.getElementById('nameInput').value;
    if (!isInit)
      updateConfig(config);
  }
  
  function setUiTheme(uiTheme, isInit) {
    if (!uiTheme)
      uiTheme = 'Default';
    if (hasUiThemes)
      config.uiTheme = uiTheme;
    const themeStyles = document.getElementById('themeStyles');
    getBaseBgColor(uiTheme, function (color) {
      const bgColorPixel = uiThemeBgColors[uiTheme];
      const altColor = 'rgba(' + Math.min(bgColorPixel[0] + 48, 255) + ', ' + Math.min(bgColorPixel[1] + 48, 255) + ', ' + Math.min(bgColorPixel[2] + 48, 255) + ', 1)';
      getFontShadow(uiTheme, function (shadow) {
        themeStyles.textContent = themeStyles.textContent.replace(new RegExp('url\\(\'images\\/ui\\/[a-zA-Z0-9]+\\/(?:[a-zA-Z0-9\\_]+\\/)?(containerbg|border(?:2)?|font\\d)\\.png\'\\)', 'g'), 'url(\'images/ui/' + gameId + (hasUiThemes ? '/' + config.uiTheme : '') + '/$1.png\')')
          .replace(/background-color:( *)[^;!]*(!important)?;( *)\/\*basebg\*\//g, 'background-color:$1' + color + '$2;$3/*basebg*/')
          .replace(/background-color:( *)[^;!]*(!important)?;( *)\/\*altbg\*\//g, 'background-color:$1' + altColor + '$2;$3/*altbg*/')
          .replace(/(?:[#a-zA-Z0-9]+|rgba\([0-9]+, [0-9]+, [0-9]+, [0-9]+\))(;? *)\/\*shadow\*\//g, shadow + '$1/*shadow*/');
        const useFullBg = hasUiThemes && document.querySelector('.uiTheme option[value="' + uiTheme + '"]').classList.contains('fullBg');
        const containers = document.querySelectorAll('.container');
        for (let container of containers)
          container.classList.toggle('fullBg', useFullBg);
        document.querySelector('body').classList.toggle('fullBg', useFullBg);
        if (!isInit) {
          document.querySelector('.fontStyle').onchange();
          if (hasUiThemes)
            updateConfig(config);
        }
      });
    });
  }
  
  function setFontStyle(fontStyle, isInit) {
    config.fontStyle = fontStyle;
    const themeStyles = document.getElementById('themeStyles');
    const defaultAltFontStyleIndex = parseInt(document.querySelector('.fontStyle option:last-child').value);
    getFontColor(config.uiTheme || 'Default', fontStyle, function (baseColor) {
      const altFontStyle = fontStyle !== defaultAltFontStyleIndex ? defaultAltFontStyleIndex : 0;
      const altColorCallback = function (altColor) {
        themeStyles.textContent = themeStyles.textContent
          .replace(new RegExp('url\\(\'images\\/ui\\/[a-zA-Z0-9]+\\/(?:[a-zA-Z0-9\\_]+\\/)?font\\d\\.png\'\\)( *!important)?;( *)\\/\\*base\\*\\/', 'g'), 'url(\'images/ui/' + gameId + (hasUiThemes ? '/' + config.uiTheme : '') + '/font' + (fontStyle + 1) + '.png\')$1;$2/*base*/')
          .replace(new RegExp('url\\(\'images\\/ui\\/[a-zA-Z0-9]+\\/(?:[a-zA-Z0-9\\_]+\\/)?font\\d\\.png\'\\)( *!important)?;( *)\\/\\*alt\\*\\/', 'g'), 'url(\'images/ui/' + gameId + (hasUiThemes ? '/' + config.uiTheme : '') + '/font' + (altFontStyle + 1) + '.png\')$1;$2/*alt*/')
          .replace(/([^\-])((?:(?:background|border)\-)?color|stroke):( *)[^;!]*(!important)?;( *)\/\*base\*\//g, '$1$2:$3' + baseColor + '$4;$5/*base*/')
          .replace(/([^\-])((?:(?:background|border)\-)?color|stroke):( *)[^;!]*(!important)?;( *)\/\*alt\*\//g, '$1$2:$3' + altColor + '$4;$5/*alt*/');
        if (!isInit)
          updateConfig(config);
      };
      getFontColor(config.uiTheme || 'Default', altFontStyle, function (altColor) {
        if (altColor !== baseColor)
          altColorCallback(altColor);
        else {
          const fallbackAltFontStyle = fontStyle !== defaultAltFontStyleIndex ? parseInt(document.querySelector('.fontStyle option:first-child').value) : 1;
          getFontColor(config.uiTheme || 'Default', fallbackAltFontStyle, altColorCallback);
        }
      });
    });
  }
  
  let uiThemeBgColors = {};
  let uiThemeFontShadows = {};
  let uiThemeFontColors = {};
  
  function getFontColor(uiTheme, fontStyle, callback) {
    if (!uiThemeFontColors[uiTheme])
      uiThemeFontColors[uiTheme] = {};
    let pixel = uiThemeFontColors[uiTheme][fontStyle];
    if (pixel)
      return callback('rgba(' + pixel[0] + ', ' + pixel[1] + ', ' + pixel[2] + ', 1)');
    const img = new Image();
    img.onload = function () {
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      context.drawImage(img, 0, 0);
      pixel = context.getImageData(0, 8, 1, 1).data;
      uiThemeFontColors[uiTheme][fontStyle] = [ pixel[0], pixel[1], pixel[2] ];
      callback('rgba(' + pixel[0] + ', ' + pixel[1] + ', ' + pixel[2] + ', 1)');
      canvas.remove();
    };
    img.src = 'images/ui/' + gameId + (hasUiThemes ? '/' + uiTheme : '') + '/font' + (fontStyle + 1) + '.png';
  }

  function getFontShadow(uiTheme, callback) {
    let pixel = uiThemeFontShadows[uiTheme];
    if (pixel)
      return callback('rgba(' + pixel[0] + ', ' + pixel[1] + ', ' + pixel[2] + ', 1)');
    const img = new Image();
    img.onload = function () {
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      context.drawImage(img, 0, 0);
      pixel = context.getImageData(0, 8, 1, 1).data;
      uiThemeFontShadows[uiTheme] = [ pixel[0], pixel[1], pixel[2] ];
      callback('rgba(' + pixel[0] + ', ' + pixel[1] + ', ' + pixel[2] + ', 1)');
      canvas.remove();
    };
    img.src = 'images/ui/' + gameId + (hasUiThemes ? '/' + uiTheme : '') + '/fontshadow.png';
  }

  function getBaseBgColor(uiTheme, callback) {
    const img = new Image();
    let pixel = uiThemeBgColors[uiTheme];
    if (pixel)
      return callback('rgba(' + pixel[0] + ', ' + pixel[1] + ', ' + pixel[2] + ', 1)');
    img.onload = function () {
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      context.drawImage(img, 0, 0);
      pixel = context.getImageData(0, 0, 1, 1).data;
      const pixel2 = context.getImageData(4, 4, 1, 1).data;
      const pixel3 = context.getImageData(8, 8, 1, 1).data;
      const r = Math.round((pixel[0] + pixel2[0] + pixel3[0]) / 3);
      const g = Math.round((pixel[1] + pixel2[1] + pixel3[1]) / 3);
      const b = Math.round((pixel[2] + pixel2[2] + pixel3[2]) / 3);
      uiThemeBgColors[uiTheme] = [ r, g, b ];
      callback('rgba(' + r + ', ' + g + ', ' + b + ', 1)');
      canvas.remove();
    };
    img.src = 'images/ui/' + gameId + (hasUiThemes ? '/' + uiTheme : '') + '/containerbg.png';
  }

  function handleSaveFileUpload(evt) {
    const save = evt.target.files[0];

    if (!/^Save\d{2}\.lsd$/.test(save.name)) {
      alert(localizedMessages.io.upload.invalidSaveFile);
      document.getElementById('uploadButton').click();
      return;
    }

    const saveSlot = getSaveSlot();

    if (saveSlot == null)
      return;

    const request = indexedDB.open(`/easyrpg/${gameId}/Save`);

    request.onsuccess = function (e) {

      const reader = new FileReader();
      let readerResult;

      reader.onload = function (file) {
        readerResult = file.currentTarget.result;
        const saveFile = { timestamp: new Date(), mode: 33206, contents: new Uint8Array(readerResult) };
    
        const db = request.result; 
        const transaction = db.transaction(['FILE_DATA'], 'readwrite');
        transaction.objectStore('FILE_DATA').put(saveFile, `/easyrpg/${gameId}/Save/Save${saveSlot}.lsd`);

        window.location = window.location;
      };

      reader.readAsArrayBuffer(save);
    };
  }

  function handleSaveFileDownload() {
    const request = indexedDB.open(`/easyrpg/${gameId}/Save`);

    request.onsuccess = function (e) {
      const saveSlot = getSaveSlot(true);

      if (saveSlot == null)
        return;

      const db = request.result; 
      const transaction = db.transaction(['FILE_DATA'], 'readwrite');
      const objectStore = transaction.objectStore('FILE_DATA');
      const objectStoreRequest = objectStore.get(`/easyrpg/2kki/Save/Save${saveSlot}.lsd`);

      objectStoreRequest.onsuccess = function (event) {
        const record = objectStoreRequest.result;

        if (!record) {
          alert(localizedMessages.io.download.emptySlot);
          return;
        }

        const blob = new Blob([record.contents], {type: 'text/json'});
        const link = document.createElement('a');
        link.href = window.URL.createObjectURL(blob);
        link.download = `Save${saveSlot}.lsd`;
        link.click();
        link.remove();
      };
    };
  }

  function getSaveSlot(download) {
    let fileIndex = prompt(localizedMessages.io[download ? 'download' : 'upload'].slotInput, 1);
    let fileIndexInt;

    while (fileIndex != null && !/^\d+$/.test(fileIndex) || (fileIndexInt = parseInt(fileIndex)) < 1 || fileIndexInt > 15)
      fileIndex = prompt(localizedMessages.io.common.failedSlotInput);

    if (fileIndex == null)
      return null;

    return fileIndexInt < 10 ? `0${fileIndexInt}` : fileIndexInt.toString();
  }

  function initLocalization(isInitial) {
    if (isInitial && gameId === '2kki') {
      const uiThemeOptions = document.querySelectorAll('.uiTheme option');
      for (let option of uiThemeOptions)
        option.setAttribute('data-i18n', `[html]uiTheme.values.2kki.${option.value}`);
    }
    document.getElementsByTagName('html')[0].lang = config.lang;
    fetch(`lang/${config.lang}.json`)
      .then(function (response) {
        return response.json();
      })
      .then(function (jsonResponse) {
        const version = jsonResponse.version[gameId];
        if (version) {
          const versionElement = document.querySelector('.version');
          const versionMeta = document.querySelector(`meta[name="${gameId}Version"]`);
          if (versionElement && versionMeta) {
            const substituteKeys = Object.keys(version.substitutes);
            let versionLabel = version.label.replace('{VERSION}', `<span class="preserve-spacing">${versionMeta.content || '?'}</span>`);
            for (let sk of substituteKeys)
              versionLabel = versionLabel.replace(sk, version.substitutes[sk]);
            versionElement.innerHTML = versionLabel;
          }
        }
        if (config.lang === 'ja')
          convertJPLabels(jsonResponse.ui);
        localizedMessages = jsonResponse.messages;
        const resourcesJson = {};
        resourcesJson[config.lang] = { translation: jsonResponse.ui };
        i18next.init({
          lng: config.lang,
          resources: resourcesJson,
          preventValueFromContent: false
        }, function (err, t) {
          if (err)
            console.error(err);
          locI18next.init(i18next)('[data-i18n]');
        });
      });
  }

  function convertJPLabels(data) {
    if (data) {
        Object.keys(data).forEach(function (key) {
            const value = data[key];
            if (value) {
                switch (typeof value) {
                    case 'object':
                        convertJPLabels(value);
                        break;
                    case 'string':
                        if (value.indexOf(' ') > -1)
                            data[key] = value.split(/ +/g).map(v => `<span class="jp-word-break">${v}</span>`).join('');
                        break;
                }
            }
        });
    }
}
  
  function loadOrInitConfig() {
    try {
      const configKey = `config_${gameId}`;
      if (!window.localStorage.hasOwnProperty(configKey))
        window.localStorage.setItem(configKey, JSON.stringify(config));
      else {
        const savedConfig = JSON.parse(window.localStorage.getItem(configKey));
        const savedConfigKeys = Object.keys(savedConfig);
        for (let k in savedConfigKeys) {
          const key = savedConfigKeys[k];
          if (config.hasOwnProperty(key)) {
            let value = savedConfig[key];
            switch (key) {
              case 'lang':
                document.getElementById('lang').value = value;
                setLang(value, true);
                break;
              case 'name':
                document.getElementById('nameInput').value = value;
                setName(value, true);
                break;
              case 'uiTheme':
                if (hasUiThemes)
                  document.querySelector('.uiTheme').value = value;
                setUiTheme(value, true);
                break;
              case 'fontStyle':
                document.querySelector('.fontStyle').value = value;
                setFontStyle(value, true);
                break;
              case 'locationCache':
                locationCache = Object.assign({}, value);
                break;
              case 'mapCache':
                mapCache = Object.assign({}, value);
                break;
            }
            config[key] = value;
          }
        }
      }
    } catch (error) {
      console.error(error);
    }
  }
  
  function updateConfig(config) {
    try {
      window.localStorage[`config_${gameId}`] = JSON.stringify(config);
    } catch (error) {
    }
  }

  onResize();
  
  loadOrInitConfig();

  if (!config.hasOwnProperty('fontStyle'))
    setFontStyle(0, true);
  if (!config.hasOwnProperty('uiTheme'))
    setUiTheme('Default', true);
  if (!localizedMessages)
    initLocalization(true);
</script>

</body>
</html>
